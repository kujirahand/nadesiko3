const assert = require('assert')
const NakoCompiler = require('../src/nako3')

describe('basic', () => {
  const nako = new NakoCompiler()
  // nako.logger.addSimpleLogger('trace')
  const cmp = (code, res) => {
    nako.logger.debug('code=' + code)
    assert.strictEqual(nako.runReset(code).log, res)
  }
  const cmpNakoFuncs = (code, res) => {
    nako.logger.debug('code=' + code)
    nako.runReset(code)
    assert.deepStrictEqual(nako.usedFuncs, res)
  }
  // --- test ---
  it('print simple', () => {
    cmp('3ã‚’è¡¨ç¤º', '3')
  })
  it('print', () => {
    cmp('3ã‚’è¡¨ç¤º', '3')
    cmp('100ã‚’è¡¨ç¤º', '100')
    cmp('0xFFã‚’è¡¨ç¤º', '255')
  })
  it('string', () => {
    cmp('ã€Œabcã€ã‚’è¡¨ç¤º', 'abc')
    cmp('"abc"ã‚’è¡¨ç¤º', 'abc')
    cmp('â€œã‚ã„ã†â€ã‚’è¡¨ç¤º', 'ã‚ã„ã†')
  })
  it('rawstring', () => {
    cmp('ã€abcã€ã‚’è¡¨ç¤º', 'abc')
    cmp('\'abc\'ã‚’è¡¨ç¤º', 'abc')
    cmp('ã€abc{30}abcã€ã‚’è¡¨ç¤º', 'abc{30}abc')
  })
  it('exstring', () => {
    cmp('a=30;ã€Œabc{a}abcã€ã‚’è¡¨ç¤º', 'abc30abc')
    cmp('a=30;ã€Œabcï½›aï½abcã€ã‚’è¡¨ç¤º', 'abc30abc')
  })
  it('raw string - ğŸŒ¿ .. ğŸŒ¿', () => {
    cmp('a=ğŸŒ¿abcğŸŒ¿;aã‚’è¡¨ç¤º', 'abc')
  })
  it('EX string - ğŸŒ´ .. ğŸŒ´', () => {
    cmp('v=30;a=ğŸŒ´abc{v}abcğŸŒ´;aã‚’è¡¨ç¤º', 'abc30abc')
  })
  it('string - LF', () => {
    cmp('a=30;ã€Œabc\nabcã€ã‚’è¡¨ç¤º', 'abc\nabc')
  })
  it('space ã€Œãƒ»ã€', () => {
    cmp('ãƒ»a=30;ãƒ»b=50ã€Œ{a}-{b}ã€ã‚’è¡¨ç¤º', '30-50')
  })
  it('string - ğŸŒ´ ... ğŸŒ´', () => {
    cmp('ğŸŒ´aaağŸŒ´ã‚’è¡¨ç¤º', 'aaa')
    cmp('a=30;ğŸŒ´aaa{a}bbbğŸŒ´ã‚’è¡¨ç¤º', 'aaa30bbb')
    cmp('a=30;ğŸŒ¿aaa{a}bbbğŸŒ¿ã‚’è¡¨ç¤º', 'aaa{a}bbb')
  })
  it('ã‚·ã‚¹ãƒ†ãƒ å®šæ•°', () => {
    cmp('ãƒŠãƒ‡ã‚·ã‚³ã‚¨ãƒ³ã‚¸ãƒ³ã‚’è¡¨ç¤º', 'nadesi.com/v3')
  })
  it('åŠ©è©ã®å¾Œã«å¥èª­ç‚¹', () => {
    cmp('ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨ã€è¡¨ç¤ºã€‚', 'ã“ã‚“ã«ã¡ã¯')
  })
  it('ä»£å…¥æ–‡', () => {
    cmp('3000ã‚’å€¤æ®µã«ä»£å…¥ã€‚å€¤æ®µã‚’è¡¨ç¤º', '3000')
    cmp('å€¤æ®µã«3000ã‚’ä»£å…¥ã€‚å€¤æ®µã‚’è¡¨ç¤º', '3000')
    cmp('ã€…=3000ã€‚ã€…ã‚’è¡¨ç¤º', '3000')
    cmp('ã€…ã«3000ã‚’ä»£å…¥ã€‚ã€…ã‚’è¡¨ç¤º', '3000')
  })
  it('é€£æ–‡å¾Œã®ä»£å…¥æ–‡', () => {
    cmp('ã€Œaabbccã€ã®ã€Œaaã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦Fã«ä»£å…¥ã€‚Fã‚’è¡¨ç¤º', 'bbcc')
    cmp('ã€Œaabbccã€ã®ã€Œaaã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦ã€Œbbã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦Fã«ä»£å…¥ã€‚Fã‚’è¡¨ç¤º', 'cc')
  })
  it('ã€œã‚’ã€œã«å®šã‚ã‚‹', () => {
    cmp('Aã‚’0.8ã«å®šã‚ã¦Aã‚’è¡¨ç¤º', '0.8')
  })
  it('æ–‡å­—åˆ— - &ã¨æ”¹è¡Œ', () => {
    cmp('ã€Œaaaã€& _\nã€Œbbbã€ã‚’è¡¨ç¤ºã€‚', 'aaabbb')
    cmp('A= 1 + 1 + 1 + 1 + 1 + _\n1 + 1\nAã‚’è¡¨ç¤º', '7')
    cmp('A= 1 + 1 + 1 + 1 + 1 + _\r\n1 + 1 + 1\r\nAã‚’è¡¨ç¤º', '8')
    cmp('A= 1 + 1 + 1 + 1 + 1 + _  \r\n1 + 3  \r\nAã‚’è¡¨ç¤º', '9')
    cmp('A = 1 + _\n' +
      '    5 + _\n' +
      '    10\n' +
      'Aã‚’è¡¨ç¤ºã€‚', '16')
  })
  it('åå‰ã«æ•°å­—ã‚’æŒã¤å¤‰æ•°ã‚’ä½¿ã†', () => {
    cmp('A1=30;B1=20;ã€Œ{A1}{B1}ã€ã‚’è¡¨ç¤ºã€‚', '3020')
  })
  it('åå‰ã«çµµæ–‡å­—ã‚’æŒã¤å¤‰æ•°ã‚’ä½¿ã†', () => {
    cmp('\u1F60=30;\u1F60ã‚’è¡¨ç¤ºã€‚', '30')
    cmp('ğŸ˜„=30;ğŸ˜„ã‚’è¡¨ç¤ºã€‚', '30')
  })
  it('ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œãªã„å•é¡Œ (#112)', () => {
    cmp('A=50 # hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 ï¼ƒ hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 â€» hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 // hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 ï¼ï¼ hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° # hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° ï¼ƒ hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° â€» hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° // hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° ï¼ï¼ hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
  })
  it('ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã«æ–‡å­—åˆ—è¨˜å·ãŒã‚ã‚Šé–‰ã˜ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹(#725)', () => {
    cmp('A=50 # \"hogehoge\nAã‚’è¡¨ç¤º', '50')
  })
  it('ç¯„å›²ã‚³ãƒ¡ãƒ³ãƒˆã«æ–‡å­—åˆ—è¨˜å·ãŒã‚ã‚Šé–‰ã˜ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹(#731)', () => {
    cmp('A=50 /* " */Aã‚’è¡¨ç¤º', '50')
    cmp('A=50 /* \' */Aã‚’è¡¨ç¤º', '50')
  })
  it('usedFuncs', () => {
    cmpNakoFuncs('â—({é–¢æ•°}fã§aã‚’)æ¼”ç®—å‡¦ç†ã¨ã¯;ãã‚Œã¯ã€f(a);ã“ã“ã¾ã§;â—(aã‚’)äºŒå€å‡¦ç†ã¨ã¯;ãã‚Œã¯a*2;ã“ã“ã¾ã§;äºŒå€å‡¦ç†ã§2ã‚’æ¼”ç®—å‡¦ç†ã—ã¦è¡¨ç¤º', new Set(['è¡¨ç¤º']))
  })
  it('è«–æ–‡ãªã©ã§ä½¿ã‚ã‚Œã‚‹å¥èª­ç‚¹ã€Œï¼Œã€ã‚’ã€Œã€ã€(#735)', () => {
    cmp('A1=30;B1=20;(A1+B1)ã‚’ï¼Œè¡¨ç¤º', '50')
    cmp('A=ï¼“ï¼ï¼‘ï¼”;Aã‚’ï¼Œè¡¨ç¤º', '3.14')
  })
  it('æ¡ä»¶åˆ†å²ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡', () => {
    cmp(
      'ï¼ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
      '3ã§æ¡ä»¶åˆ†å²\n' +
      '    2ãªã‚‰ã°\n' +
      '        1ã‚’è¡¨ç¤º\n' +
      '    3ãªã‚‰ã°\n' +
      '        2ã‚’è¡¨ç¤º\n' +
      '    é•ãˆã°\n' +
      '        3ã‚’è¡¨ç¤º\n',
      '2'
    )
  })
  it('ç‹¬ç«‹ã—ãŸåŠ©è©ã€ãªã‚‰ã°ã€ã®ä½ç½®ã®å–å¾—', () => {
    const out = nako.lex('ã‚‚ã—å­˜åœ¨ã™ã‚‹ãªã‚‰ã°\nã“ã“ã¾ã§')
    const sonzai = out.tokens.find((t) => t.value === 'å­˜åœ¨')
    const naraba = out.tokens.find((t) => t.type === 'ãªã‚‰ã°')

    // ã€Œå­˜åœ¨ã™ã‚‹ã€
    assert.strictEqual(sonzai.startOffset, 2)
    assert.strictEqual(sonzai.endOffset, 6)

    // ãªã‚‰ã°
    assert.strictEqual(naraba.startOffset, 6)
    assert.strictEqual(naraba.endOffset, 9)
  })
  it('preCodeã‚’è€ƒæ…®ã—ãŸã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—', () => {
    const preCode = '1ã‚’è¡¨ç¤º\n2ã‚’è¡¨ç¤º\n3ã‚’'
    const tokens = nako.lex(preCode + 'è¡¨ç¤º', 'main.nako3', preCode).tokens

    // '3' ã¯-2ã‹ã‚‰0æ–‡å­—ç›®
    const three = tokens.findIndex((t) => t.value === 3)
    assert.strictEqual(tokens[three].startOffset, -2)
    assert.strictEqual(tokens[three].endOffset, 0)
    assert.strictEqual(tokens[three].line, 0)
    assert.strictEqual(tokens[three].column, -2)

    // 'è¡¨ç¤º' ã¯0~1æ–‡å­—ç›®
    assert.strictEqual(tokens[three + 1].startOffset, 0)
    assert.strictEqual(tokens[three + 1].endOffset, 2)
    assert.strictEqual(tokens[three + 1].line, 0)
    assert.strictEqual(tokens[three + 1].column, 0)
  })
  it('å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ - 1è¡Œã®ã¿', () => {
    nako.reset()
    cmp(`
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã—ã¦1ã‚’è¡¨ç¤º
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã—ã¦2ã‚’è¡¨ç¤º
`, '1\n2')
  })
  it('å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ - ãƒ–ãƒ­ãƒƒã‚¯å†…ã«é©ç”¨', () => {
    // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããªã‘ã‚Œã°ã€ã€Œå®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã€ãŒç„¡ã„å ´åˆã¨åŒã˜å‹•ä½œã‚’ã™ã‚‹ã€‚
    cmp(`\
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ
    â—Fã¨ã¯
        2ã‚’è¡¨ç¤º
        3ã‚’è¡¨ç¤º
    ã“ã“ã¾ã§
    1ã‚’è¡¨ç¤º
    F
ã“ã“ã¾ã§
4ã‚’è¡¨ç¤º
`, '1\n2\n3\n4')
  })
  it('ç©ºç™½ã§åŒºåˆ‡ã£ã¦æ–‡ã‚’ã¤ãªã’ãŸå ´åˆ', () => {
    cmp('1ã¨2ã‚’è¶³ã™ 1ã¨2ã‚’è¶³ã™', '')
  })
  it('return_none: true ã®addFuncã§å®šç¾©ã—ãŸé–¢æ•°ãŒã€Œãã‚Œã€ã«å€¤ã‚’ä»£å…¥ã—ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹', () => {
    const nako = new NakoCompiler()
    nako.addFunc('hoge', [], () => {}, true)
    assert.strictEqual(nako.runReset('1ã¨2ã‚’è¶³ã™\nhoge\nãã‚Œã‚’è¡¨ç¤º').log, '3')
  })
  it('åˆ¶å¾¡æ§‹æ–‡ã§ä¸€èªé–¢æ•°ã‚’ä½¿ã†', () => {
    cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nã‚‚ã—ä¸€ãªã‚‰ã°\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§', '1') // if
    cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€å›\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§', '1') // times
    cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€ã®é–“\n1ã‚’è¡¨ç¤º\næŠœã‘ã‚‹\nã“ã“ã¾ã§', '1') // while
    cmp('â—ä¸€ã¨ã¯\n[1]ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€ã‚’åå¾©\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§', '1') // foreach
    cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€ã§æ¡ä»¶åˆ†å²\n1ãªã‚‰ã°\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§\nã“ã“ã¾ã§', '1') // switch
  })
  it('ãã†', () => {
    // ã€Œãã†ã€ã¯ã€Œãã‚Œã€ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
    cmp('ãã‚Œï¼1;ãã†ã‚’è¡¨ç¤º', '1')
    cmp('1ã«3ã‚’è¶³ã™;ãã†ã‚’è¡¨ç¤º', '4')
  })
  it('ã€Œã€œæ™‚é–“ã€ã®ã€Œé–“ã€ã‚’åˆ¶å¾¡æ§‹æ–‡ã¨ã—ã¦èªè­˜ã•ã›ãªã„ #831', () => {
    cmp('æ™‚é–“=1\nï¼ˆæ™‚é–“ï¼‰ã‚’è¡¨ç¤º', '1')
  })
  it('ã€Œã‚‚ã—FãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã°ã€ãŒFã¨ã€Œå­˜åœ¨ã™ã‚‹ã€ã®æ¯”è¼ƒã«ãªã‚‹å•é¡Œã®ä¿®æ­£ #830', () => {
    cmp('â—ï¼ˆAãŒï¼‰hogeã¨ã¯\n' +
        '    1ã‚’æˆ»ã™\n' +
        'ã“ã“ã¾ã§\n' +
        'ã‚‚ã—ã€FãŒhogeãªã‚‰ã°\n' +
        '    1ã‚’è¡¨ç¤º\n' +
        'ã“ã“ã¾ã§',
        // ---
        '1')
  })
  it('ç„¡åé–¢æ•°ãŒè­¦å‘Šã‚’å‡ºã™å•é¡Œã®ä¿®æ­£ #841', () => {
    let log = ''
    nako.logger.addListener('warn', ({ noColor }) => { log += noColor })
    nako.parse(
      'f = é–¢æ•°(x) ãã‚Œã¯ã€xã€‚ã“ã“ã¾ã§ã€‚\n' +
      'g = é–¢æ•°(x) ãã‚Œã¯ã€xã€‚ã“ã“ã¾ã§ã€‚\n'
      , 'main.nako3')
    assert.strictEqual(log, '')
  })
})
