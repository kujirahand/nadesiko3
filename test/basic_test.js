const assert = require('assert')
const NakoCompiler = require('../src/nako3')

describe('basic', () => {
  const nako = new NakoCompiler()
  // nako.debug = true;
  const cmp = (code, res) => {
    if (nako.debug) {
      console.log('code=' + code)
    }
    assert.equal(nako.runReset(code).log, res)
  }
  // --- test ---
  it('print simple', () => {
    cmp('3ã‚’è¡¨ç¤º', '3')
  })
  it('print', () => {
    cmp('3ã‚’è¡¨ç¤º', '3')
    cmp('100ã‚’è¡¨ç¤º', '100')
    cmp('0xFFã‚’è¡¨ç¤º', '255')
  })
  it('string', () => {
    cmp('ã€Œabcã€ã‚’è¡¨ç¤º', 'abc')
    cmp('"abc"ã‚’è¡¨ç¤º', 'abc')
    cmp('â€œã‚ã„ã†â€ã‚’è¡¨ç¤º', 'ã‚ã„ã†')
  })
  it('rawstring', () => {
    cmp('ã€abcã€ã‚’è¡¨ç¤º', 'abc')
    cmp('\'abc\'ã‚’è¡¨ç¤º', 'abc')
    cmp('ã€abc{30}abcã€ã‚’è¡¨ç¤º', 'abc{30}abc')
  })
  it('exstring', () => {
    cmp('a=30;ã€Œabc{a}abcã€ã‚’è¡¨ç¤º', 'abc30abc')
    cmp('a=30;ã€Œabcï½›aï½abcã€ã‚’è¡¨ç¤º', 'abc30abc')
  })
  it('raw string - R{{{ .. }}}', () => {
    cmp('a=R{{{abc}}};aã‚’è¡¨ç¤º', 'abc')
  })
  it('EX string - S{{{{{ .. }}}}}', () => {
    cmp('v=30;a=S{{{{{abc{v}abc}}}}};aã‚’è¡¨ç¤º', 'abc30abc')
  })
  it('string - LF', () => {
    cmp('a=30;ã€Œabc\nabcã€ã‚’è¡¨ç¤º', 'abc\nabc')
  })
  it('string - æ–‡å­—åˆ—{{{ ... }}}', () => {
    cmp('æ–‡å­—åˆ—{{{aaa}}}ã‚’è¡¨ç¤º', 'aaa')
    cmp('a=30;æ–‡å­—åˆ—{{{aaa{a}bbb}}}ã‚’è¡¨ç¤º', 'aaa30bbb')
    cmp('a=30;æ–‡å­—åˆ—ï½›ï½›ï½›aaa{a}bbbï½ï½ï½ã‚’è¡¨ç¤º', 'aaa30bbb')
  })
  it('ã‚·ã‚¹ãƒ†ãƒ å®šæ•°', () => {
    cmp('ãƒŠãƒ‡ã‚·ã‚³ã‚¨ãƒ³ã‚¸ãƒ³ã‚’è¡¨ç¤º', 'nadesi.com/v3')
  })
  it('JS{{{ .. }}}', () => {
    cmp('A=JS{{{31}}};Aã‚’è¡¨ç¤ºã€‚', '31')
  })
  it('åŠ©è©ã®å¾Œã«å¥èª­ç‚¹', () => {
    cmp('ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨ã€è¡¨ç¤ºã€‚', 'ã“ã‚“ã«ã¡ã¯')
  })
  it('ä»£å…¥æ–‡', () => {
    cmp('3000ã‚’å€¤æ®µã«ä»£å…¥ã€‚å€¤æ®µã‚’è¡¨ç¤º', '3000')
    cmp('å€¤æ®µã«3000ã‚’ä»£å…¥ã€‚å€¤æ®µã‚’è¡¨ç¤º', '3000')
    cmp('ã€…=3000ã€‚ã€…ã‚’è¡¨ç¤º', '3000')
    cmp('ã€…ã«3000ã‚’ä»£å…¥ã€‚ã€…ã‚’è¡¨ç¤º', '3000')
  })
  it('é€£æ–‡å¾Œã®ä»£å…¥æ–‡', () => {
    cmp('ã€Œaabbccã€ã®ã€Œaaã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦Fã«ä»£å…¥ã€‚Fã‚’è¡¨ç¤º', 'bbcc')
    cmp('ã€Œaabbccã€ã®ã€Œaaã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦ã€Œbbã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦Fã«ä»£å…¥ã€‚Fã‚’è¡¨ç¤º', 'cc')
  })
  it('æ–‡å­—åˆ— - &ã¨æ”¹è¡Œ', () => {
    cmp('ã€Œaaaã€& _\nã€Œbbbã€ã‚’è¡¨ç¤ºã€‚', 'aaabbb')
    cmp('A= 1 + 1 + 1 + 1 + 1 + _\n1 + 1\nAã‚’è¡¨ç¤º', '7')
    cmp('A= 1 + 1 + 1 + 1 + 1 + _\r\n1 + 1 + 1\r\nAã‚’è¡¨ç¤º', '8')
    cmp('A= 1 + 1 + 1 + 1 + 1 + _  \r\n1 + 3  \r\nAã‚’è¡¨ç¤º', '9')
    cmp('A = 1 + _\n' +
      '    5 + _\n' +
      '    10\n' +
      'Aã‚’è¡¨ç¤ºã€‚', '16')
  })
  it('åå‰ã«æ•°å­—ã‚’æŒã¤å¤‰æ•°ã‚’ä½¿ã†', () => {
    cmp('A1=30;B1=20;ã€Œ{A1}{B1}ã€ã‚’è¡¨ç¤ºã€‚', '3020')
  })
  it('åå‰ã«çµµæ–‡å­—ã‚’æŒã¤å¤‰æ•°ã‚’ä½¿ã†', () => {
    cmp('\u1F60=30;\u1F60ã‚’è¡¨ç¤ºã€‚', '30')
    cmp('ğŸ˜„=30;ğŸ˜„ã‚’è¡¨ç¤ºã€‚', '30')
  })
  it('ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œãªã„å•é¡Œ (#112)', () => {
    cmp('A=50 # hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 ï¼ƒ hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 â€» hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 // hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50 ï¼ï¼ hogehoge\nAã‚’è¡¨ç¤º', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° # hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° ï¼ƒ hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° â€» hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° // hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° ï¼ï¼ hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
  })
  it('used_funcs', () => {
    const code = 'â—ã¦ã™ã™;ä»Šæ—¥ã‚’è¡¨ç¤º;ã“ã“ã¾ã§;ã¦ã™ã™;ã€Œã‚ã‚ã€ã¨è¡¨ç¤º'

    if (nako.debug) {
      console.log('code=' + code)
    }

    nako.runReset(code)
    assert.deepEqual(nako.usedFuncs, new Set(['ä»Šæ—¥', 'è¡¨ç¤º']))
  })
})
