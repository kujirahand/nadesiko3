const assert = require('assert')
const NakoIndent = require('../../src/nako_indent')

describe('indent', () => {
    const cmp = (src, expected) => {
        src = NakoIndent.convert(src).code
        src = src.replace(/\s+$/, '')
        expected = expected.replace(/\s+$/, '')
        assert.strictEqual(src, expected)
    }
    it('ã‚‚ã—', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€1ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€ã€Œã‚ã‚“ã€ã¨è¡¨ç¤ºã€‚\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            'ã€€ã€€ã€Œã‚ã‚“ã€ã¨è¡¨ç¤ºã€‚\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('ã‚‚ã— é•ãˆã°', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'é•ãˆã°\n'+
            'ã€€ã€€2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'é•ãˆã°\n' +
            'ã€€ã€€2ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('3å›ã¨5å›', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            '5å›\n' +
            'ã€€ã€€3å›\n'+
            'ã€€ã€€ã€€ã€€1ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            '5å›\n' +
            'ã€€ã€€3å›\n' +
            'ã€€ã€€ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            '    ã“ã“ã¾ã§â€°\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('ã‚‚ã— é•ãˆã° å…¥ã‚Œå­', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€ã‚‚ã—B=1ãªã‚‰ã°\n' +
            'ã€€ã€€ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'ã€€ã€€é•ãˆã°\n' +
            'ã€€ã€€ã€€ã€€2ã‚’è¡¨ç¤º\n' +
            'é•ãˆã°\n'+
            'ã€€ã€€3ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€ã‚‚ã—B=1ãªã‚‰ã°\n' +
            'ã€€ã€€ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'ã€€ã€€é•ãˆã°\n' +
            'ã€€ã€€ã€€ã€€2ã‚’è¡¨ç¤º\n' +
            '    ã“ã“ã¾ã§â€°\n' +
            'é•ãˆã°\n'+
            'ã€€ã€€3ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('JSONã§æ”¹è¡ŒãŒã‚ã‚‹å ´åˆ(#699)', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'J={"taro":30,\n'+
            '   "jiro":50}\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'J={"taro":30,\n'+
            '   "jiro":50}\n')
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'S=ã€Œaaa\n'+
            'bbbã€\n'+
            'ã‚‚ã—S=30ãªã‚‰ã°\n' +
            'ã€€ã€€ã€Œã‚ã€ã¨è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'S=ã€Œaaa\n'+
            'bbbã€\n'+
            'ã‚‚ã—S=30ãªã‚‰ã°\n' +
            'ã€€ã€€ã€Œã‚ã€ã¨è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('ã‚³ãƒ¡ãƒ³ãƒˆå†…ã«æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã®é–‹å§‹è¨˜å·ãŒã‚ã‚‹å ´åˆ', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            `ã€€ã€€1ã‚’è¡¨ç¤º # ã€Œ\n`+
            '2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            `ã€€ã€€1ã‚’è¡¨ç¤º # ã€Œ\n`+
            'ã“ã“ã¾ã§â€°\n'+
            '2ã‚’è¡¨ç¤º\n'
        )
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            `ã€€ã€€1ã‚’è¡¨ç¤º // ã€Œ\n`+
            '2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            `ã€€ã€€1ã‚’è¡¨ç¤º // ã€Œ\n`+
            'ã“ã“ã¾ã§â€°\n'+
            '2ã‚’è¡¨ç¤º\n'
        )
    })
    it('è¤‡æ•°è¡Œã‚³ãƒ¡ãƒ³ãƒˆå†…ã«æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã®é–‹å§‹è¨˜å·ãŒã‚ã‚‹å ´åˆ', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            `ã€€ã€€1ã‚’è¡¨ç¤º /* ã€Œ */\n`+
            '2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            `ã€€ã€€1ã‚’è¡¨ç¤º /* ã€Œ */\n`+
            'ã“ã“ã¾ã§â€°\n'+
            '2ã‚’è¡¨ç¤º\n'
        )
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            `ã€€ã€€1ã‚’è¡¨ç¤º ï¼ï¼Š ã€Œ ï¼Šï¼\n`+
            '2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            `ã€€ã€€1ã‚’è¡¨ç¤º ï¼ï¼Š ã€Œ ï¼Šï¼\n`+
            'ã“ã“ã¾ã§â€°\n'+
            '2ã‚’è¡¨ç¤º\n'
        )
    })
    it('æ”¹è¡Œã‚’å«ã‚€ã€çµµæ–‡å­—ã«ã‚ˆã‚‹æ–‡å­—åˆ—ãŒã‚ã‚‹å ´åˆ', () => {
        cmp(
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
            '2å›\n' +
            '    ğŸŒ´ï¼‘\n' +
            'ğŸŒ´ã‚’è¡¨ç¤º\n' +
            'ã€Œ2ã€ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
            '2å›\n' +
            '    ğŸŒ´ï¼‘\n' +
            'ğŸŒ´ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n' +
            'ã€Œ2ã€ã‚’è¡¨ç¤º\n'
        )
    })
    it('å‰å¾ŒãŒä¸€è‡´ã—ãªã„æ‹¬å¼§ãŒã‚ã‚‹å ´åˆ', () => {
        cmp(
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
            '2å›\n' +
            '   A=ï½›\n' +
            '}ã‚’è¡¨ç¤º\n' +
            '1ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
            '2å›\n' +
            '   A=ï½›\n' +
            '}ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n' +
            '1ã‚’è¡¨ç¤º\n'
        )
    })
    it('ã€Œé•ãˆã°ã€ã«è¡Œã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆ', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'é•ãˆã° # ã‚³ãƒ¡ãƒ³ãƒˆ\n'+
            'ã€€ã€€2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'é•ãˆã° # ã‚³ãƒ¡ãƒ³ãƒˆ\n' +
            'ã€€ã€€2ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('ã€Œé•ãˆã°ã€ã«ç¯„å›²ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆ', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            '/* foo \n'+
            '*/é•ãˆã° /* bar */\n'+
            'ã€€ã€€2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            '/* foo \n'+
            '*/é•ãˆã° /* bar */\n'+
            'ã€€ã€€2ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã®è¡ŒãŒã‚ã‚‹å ´åˆ', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n'+
            'ã€€ã€€ã€€ã€€# ã‚³ãƒ¡ãƒ³ãƒˆ\n' +
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'é•ãˆã°\n'+
            '/*        */\n'+
            '/*       */ \n'+
            'ã€€ã€€2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            'ã‚‚ã—A=1ãªã‚‰ã°\n' +
            'ã€€ã€€ã€€ã€€# ã‚³ãƒ¡ãƒ³ãƒˆ\n' +
            'ã€€ã€€1ã‚’è¡¨ç¤º\n' +
            'é•ãˆã°\n' +
            '/*        */\n'+
            '/*       */ \n'+
            'ã€€ã€€2ã‚’è¡¨ç¤º\n' +
            'ã“ã“ã¾ã§â€°\n')
    })
    it('"ãƒ»"ãŒã‚ã‚‹å ´åˆ', () => {
        cmp('!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            '1å›\n' +
            'ãƒ»1å›\n' +
            'ãƒ»ãƒ»1ã‚’è¡¨ç¤º\n' +
            'ãƒ»\n' +
            'ãƒ»ãƒ»2ã‚’è¡¨ç¤º\n',
            // ---
            '!ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n'+
            '1å›\n' +
            'ãƒ»1å›\n' +
            'ãƒ»ãƒ»1ã‚’è¡¨ç¤º\n' +
            'ãƒ»ãƒ»2ã‚’è¡¨ç¤º\n' +
            '  ã“ã“ã¾ã§â€°\n' +
            'ã“ã“ã¾ã§â€°\n',
        )
    })
    it('ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—', () => {
        const result = NakoIndent.convert(
            'ï¼ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
            '\n' +
            'â—ï¼ˆnã‚’ï¼‰éšä¹—ã¨ã¯\n' +
            '    ã‚‚ã—nãŒ1ã¨ç­‰ã—ã„ãªã‚‰ã°\n' +
            '        ãã‚Œã¯1\n' +
            '    é•ãˆã°\n' +
            '        ãã‚Œã¯((n - 1)ã‚’éšä¹—) * n\n' +
            '\n' +
            'ã‚‚ã—ï¼‘ï¼ï¼‘ãªã‚‰\n' +
            '    ã€Œã“ã‚“ã«\n' +
            'ã¡ã¯ã€ã¨è¡¨ç¤º\n' +
            '\n' +
            'ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨è¡¨ç¤º\n' +
            '\n' +
            '',
        )

        /**
         * å‡ºåŠ›ã•ã‚Œã‚‹ã¹ãã‚³ãƒ¼ãƒ‰:
         * ```
         *  0ï¼ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡
         *  1 â—ï¼ˆnã‚’ï¼‰éšä¹—ã¨ã¯
         *  2     ã‚‚ã—nãŒ1ã¨ç­‰ã—ã„ãªã‚‰ã°
         *  3         ãã‚Œã¯1
         *  4     é•ãˆã°
         *  5         ãã‚Œã¯((n - 1)ã‚’éšä¹—) * n
         *  6     ã“ã“ã¾ã§â€°
         *  7 ã“ã“ã¾ã§â€°
         *  8 ã‚‚ã—ï¼‘ï¼ï¼‘ãªã‚‰
         *  9     ã€Œã“ã‚“ã«
         * 10 ã¡ã¯ã€ã¨è¡¨ç¤º
         * 11 ã“ã“ã¾ã§â€°
         * 12 ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨è¡¨ç¤º
         * ```
         */

        // 6, 7, 11 è¡Œç›®ã«ã€Œã“ã“ã¾ã§â€°ã€ãŒæŒ¿å…¥ã•ã‚ŒãŸã€‚
        assert.deepStrictEqual(result.insertedLines, [6, 7, 11])

        // 1, 6, 11, 13, 13è¡Œç›®ã®ç›´å‰ã®ç©ºç™½è¡ŒãŒæ¶ˆã•ã‚ŒãŸã€‚
        // â€» æ­£ç¢ºã«ã¯ã€å„ç©ºç™½è¡Œã‚’æ¶ˆã—ãŸã¨ãã«ã€ãã‚Œã¾ã§ã«å‡ºåŠ›ã—ãŸè¡Œæ•°ï¼ˆã€Œã“ã“ã¾ã§â€°ã€ã‚’å«ã‚€ï¼‰ãŒ 1, 6, 11, 13, 13 è¡Œã€‚
        assert.deepStrictEqual(result.deletedLines, [
            { lineNumber: 1, len: 0 },
            { lineNumber: 6, len: 0 },
            { lineNumber: 11, len: 0 },
            { lineNumber: 13, len: 0 },
            { lineNumber: 13, len: 0 }
        ])
    })
    it('ãƒ–ãƒ­ãƒƒã‚¯æ§‹é€ ã®å–å¾—', () => {
        assert.deepStrictEqual(
            NakoIndent.getBlockStructure(
                'ã‚‚ã—ã¯ã„ãªã‚‰ã°\n' +
                '    ã€Œã“ã‚“\n' +
                'ã«ã¡ã¯ã€ã‚’è¡¨ç¤º\n' +
                'ã“ã“ã¾ã§',
            ),
            {
                lines: [0, 4, 4, 0], // å„è¡Œã®é«˜ã•ã¯ 0, 4, 4, 0
                pairs: [[0, 3]],     // 0è¡Œç›®ã¨3è¡Œç›®ã®ãƒšã‚¢ãŒãƒ–ãƒ­ãƒƒã‚¯ã‚’æ§‹æˆã—ã¦ã„ã‚‹ã€‚
                parents: [null, 0, 0, null],
                spaces: ['', '    ', '    ', '']
            }
        )
    })
    it('ãƒ–ãƒ­ãƒƒã‚¯æ§‹é€ ã®å–å¾— - è¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹æ§‹æ–‡', () => {
        // è¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹æ–‡ã®2è¡Œç›®ä»¥é™ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯ã€å…ˆé ­è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¨ç­‰ã—ã„ã‚‚ã®ã¨ã™ã‚‹ã€‚
        // ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã®è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯ã€ç›´è¿‘ã®é€šå¸¸ã®è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¨ç­‰ã—ã„ã‚‚ã®ã¨ã™ã‚‹ã€‚
        assert.deepStrictEqual(
            NakoIndent.getBlockStructure(
                'ï¼ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
                'Nã‚’1ã‹ã‚‰3ã¾ã§ç¹°ã‚Šè¿”ã™\n' +
                '    ã€Œ1è¡Œç›®\n' +
                '2è¡Œç›®ã€ã‚’è¡¨ç¤º\n' +
                '/*ç¯„å›²ã‚³ãƒ¡ãƒ³ãƒˆ\n' +
                '*/'
            ),
            {
                lines: [0, 0, 4, 4, 4, 4],
                pairs: [[1, 6]],
                parents: [null, null, 1, 1, 1, 1],
                spaces: ['', '', '    ', '    ', '', ''],
            }
        )
    })
    it('ãƒ–ãƒ­ãƒƒã‚¯æ§‹é€ ã®å–å¾— - é•ãˆã°', () => {
        assert.deepStrictEqual(
            NakoIndent.getBlockStructure(
                'ã‚‚ã—ã¯ã„ãªã‚‰ã°\n' +
                '    a\n' +
                'é•ãˆã°\n' +
                '    b\n' +
                'ã“ã“ã¾ã§',
            ).pairs,
            [[0, 2], [2, 4]],
        )
    })
})
