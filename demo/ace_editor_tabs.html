<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nadesiko3 Editor</title>
    <link rel="stylesheet" href="../src/wnako3_editor.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.min.js" integrity="sha512-8qx1DL/2Wsrrij2TWX5UzvEaYOFVndR7BogdpOyF4ocMfnfkw28qt8ULkXD9Tef0bLvh3TpnSAljDC7uyniEuQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-options.min.js" integrity="sha512-oHR+WVzBiVZ6njlMVlDDLUIOLRDfUUfRQ55PfkZvgjwuvGqL4ohCTxaahJIxTmtya4jgyk0zmOxDMuLzbfqQDA==" crossorigin="anonymous"></script>
    <script src="../release/wnako3.js"></script>
    <script src="../release/version.js"></script>
    <script src="../release/plugin_markup.js"></script>
    <script src="../release/plugin_csv.js"></script>
    <script src="../release/plugin_kansuji.js"></script>
    <script src="../release/plugin_datetime.js"></script>
    <script src="../release/plugin_turtle.js"></script>
    <script src="../release/plugin_caniuse.js"></script>
    <script src="../release/plugin_webworker.js"></script>

    <!-- mochaã‚’ä¸€ç•ªæœ€å¾Œã«èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.3.0/mocha.min.js" integrity="sha512-LA/TpBXau/JNubKzHQhdi5vGkRLyQjs1vpuk2W1nc8WNgf/pCqBplD8MzlzeKJQTZPvkEZi0HqBDfRC2EyLMXw==" crossorigin="anonymous"></script>

    <style>
        /* ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’æƒãˆã‚‹ */
        .toolbar button, .toolbar input {
            font-size: 12px;
            height: 28px;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            vertical-align: top;
        }

        /* å‡ºåŠ›ã®æ–‡å­—ã‚µã‚¤ã‚ºã¨æ–‡å­—è‰² */
        #output {
            font-size: 13px;
            color: rgb(77, 77, 77);
        }
    </style>
</head>
<body>
<div class="toolbar">
    <button id="add">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </button>
    <button id="remove">ğŸ—‘ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤</button>
    <span id="file-list"></span>
</div>
<div id="editor" class="nako3_editor" data-nako3-resizable="true"></div>
<div class="toolbar">
    <button id="run">è¡¨ç¤ºä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ</button>
</div>
    <div id="output"></div>
    <script>
/** @type {import('../src/wnako3.js')} */
const nako3 = navigator.nako3
const { editor, editorMarkers, editorTabs } = nako3.setupEditor('editor')

/** @type {Map<number, HTMLButtonElement>} */
const tabButtons = new Map()
/** @type {Map<number, import('../src/wnako3_editor.js').EditorTabState>} */
const hiddenTabStates = new Map()

let fileCount = 0
let activeFile = 1

// ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
const switchTab = (fileName) => {
    hiddenTabStates.set(activeFile, editorTabs.getTab())
    editorTabs.setTab(hiddenTabStates.get(fileName))
    activeFile = fileName
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ 
const addFile = () => {
    const id = ++fileCount

    // <button class="file">{id}.nako3</button> ã‚’æŒ¿å…¥ã™ã‚‹ã€‚
    const button = document.createElement('button')
    button.innerText = id + '.nako3'
    button.classList.add('file')
    button.addEventListener('click', () => {
        tabButtons.get(activeFile).disabled = false
        button.disabled = true
        switchTab(id)
    })
    document.getElementById('file-list').appendChild(button)
    tabButtons.set(id, button)

    // ã‚¨ãƒ‡ã‚£ã‚¿ã®çŠ¶æ…‹ã‚’ç”Ÿæˆ
    hiddenTabStates.set(id, editorTabs.newTab(`// ${id}.nako3\n`))
}
document.getElementById('add').addEventListener('click', () => { addFile() })

// ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
const removeFile = () => {
    if (tabButtons.size <= 1) {
        alert('å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚')
        return
    }
    const input = prompt('å‰Šé™¤ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', tabButtons.size + '.nako3')
    if (input === null) {
        return
    }
    const id = +input.replace(/\.nako3$/, '')
    if (!Number.isInteger(id)) {
        alert(`${id}.nako3 ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`)
        return
    }
    if (id === activeFile) {
        alert(`è¡¨ç¤ºä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚`)
        return
    }
    document.getElementById('file-list').removeChild(tabButtons.get(id))
    tabButtons.delete(id)
}
document.getElementById('remove').addEventListener('click', () => { removeFile() })

// å®Ÿè¡Œ
nako3.setFunc('è¡¨ç¤º', [['ã¨', 'ã‚’']], (msg) => {
    document.getElementById('output').innerText += msg + '\n'
})
document.getElementById('run').addEventListener('click', () => {
    document.getElementById('output').innerText = ''
    const filename = `${activeFile}.nako3`
    const code = editor.getValue()
    /** @type {Record<string, string>} */
    const localFiles = {}
    for (const [k, v] of hiddenTabStates) {
        localFiles[`${k}.nako3`] = v.content
    }
    nako3.loadDependencies(code, filename, '', localFiles)
        .then(() => { nako3.runReset(code, filename) })
        .catch((err) => {
            document.getElementById('output').innerText += err.message + '\n'
            if (err.filename === `${activeFile}.nako3`) {
                editorMarkers.addByError(code, err)
            }
        })
})

// 1.nako3ã®å€¤ã‚’è¨­å®šã™ã‚‹
addFile()
tabButtons.get(1).disabled = true
editor.setValue(`\
!ã€Œ2.nako3ã€ã‚’å–ã‚Šè¾¼ã‚€

ã€Œ1.nako3ã€ã‚’è¡¨ç¤º
Aã‚’è¡¨ç¤º
`)
editor.session.selection.clearSelection()

// 2.nako3ã®å€¤ã‚’è¨­å®šã™ã‚‹
addFile()
hiddenTabStates.get(2).content = `\
ã€Œ2.nako3ã€ã‚’è¡¨ç¤º
A=2
`
    </script>
</body>
</html>