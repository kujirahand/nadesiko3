/* eslint-disable no-undef */
import assert from 'assert'
import { NakoCompiler } from '../src/nako3.mjs'
import { expect } from 'chai'

describe('basic', async () => {
  // nako.logger.addListener('trace', ({ browserConsole }) => { console.log(...browserConsole) })
  const cmp = async (/** @type {string} */code, /** @type {string} */res) => {
    const nako = new NakoCompiler()
    // nako.logger.debug('code=' + code)
    assert.strictEqual((await nako.runAsync(code, 'main.nako3')).log, res)
  }
  const cmpNakoFuncs = (/** @type {string} */code, /** @type {Set<string>} */res) => {
    const nako = new NakoCompiler()
    // nako.logger.debug('code=' + code)
    const ast = nako.parse(code, 'main.nako3')
    assert.deepStrictEqual(nako.getUsedFuncs(ast), res)
  }
  // --- test ---
  it('print simple', async () => {
    await cmp('3ã‚’è¡¨ç¤º', '3')
  })
  it('print', async () => {
    await cmp('3ã‚’è¡¨ç¤º', '3')
    await cmp('100ã‚’è¡¨ç¤º', '100')
    await cmp('0xFFã‚’è¡¨ç¤º', '255')
  })
  it('string', async () => {
    await cmp('ã€Œabcã€ã‚’è¡¨ç¤º', 'abc')
    await cmp('"abc"ã‚’è¡¨ç¤º', 'abc')
    await cmp('â€œã‚ã„ã†â€ã‚’è¡¨ç¤º', 'ã‚ã„ã†')
  })
  it('rawstring', async () => {
    await cmp('ã€abcã€ã‚’è¡¨ç¤º', 'abc')
    await cmp('\'abc\'ã‚’è¡¨ç¤º', 'abc')
    await cmp('ã€abc{30}abcã€ã‚’è¡¨ç¤º', 'abc{30}abc')
  })
  it('string_ex1', async () => {
    await cmp('a=30;ã€Œabc{a}abcã€ã‚’è¡¨ç¤º', 'abc30abc')
    await cmp('a=30;ã€Œabcï½›aï½abcã€ã‚’è¡¨ç¤º', 'abc30abc')
  })
  it('string_ex2', async () => {
    await cmp('a=30;ã€Œabc{a+1}abcã€ã‚’è¡¨ç¤º', 'abc31abc')
    await cmp('a=30;ã€Œabcï½›a+1ï½abcã€ã‚’è¡¨ç¤º', 'abc31abc')
  })
  it('string_ex3', async () => {
    await cmp('a=30;ã€Œabc{aã«2ã‚’æ›ã‘ã‚‹}abcã€ã‚’è¡¨ç¤º', 'abc60abc')
    await cmp('s=ã€Œ  @   ã€;ã€Œabc{sã‚’ãƒˆãƒªãƒ }abcã€ã‚’è¡¨ç¤º', 'abc@abc')
  })
  it('raw string - ğŸŒ¿ .. ğŸŒ¿', async () => {
    await cmp('a=ğŸŒ¿abcğŸŒ¿;aã‚’è¡¨ç¤º', 'abc')
  })
  it('EX string - ğŸŒ´ .. ğŸŒ´', async () => {
    await cmp('v=30;a=ğŸŒ´abc{v}abcğŸŒ´;aã‚’è¡¨ç¤º', 'abc30abc')
  })
  it('string - LF', async () => {
    await cmp('a=30;ã€Œabc\nabcã€ã‚’è¡¨ç¤º', 'abc\nabc')
  })
  it('space ã€Œãƒ»ã€', async () => {
    await cmp('ãƒ»a=30;ãƒ»b=50ã€Œ{a}-{b}ã€ã‚’è¡¨ç¤º', '30-50')
  })
  it('string - ğŸŒ´ ... ğŸŒ´', async () => {
    await cmp('ğŸŒ´aaağŸŒ´ã‚’è¡¨ç¤º', 'aaa')
    await cmp('a=30;ğŸŒ´aaa{a}bbbğŸŒ´ã‚’è¡¨ç¤º', 'aaa30bbb')
    await cmp('a=30;ğŸŒ¿aaa{a}bbbğŸŒ¿ã‚’è¡¨ç¤º', 'aaa{a}bbb')
  })
  it('ã‚·ã‚¹ãƒ†ãƒ å®šæ•°', async () => {
    await cmp('ãƒŠãƒ‡ã‚·ã‚³ã‚¨ãƒ³ã‚¸ãƒ³ã‚’è¡¨ç¤º', 'nadesi.com/v3')
  })
  it('åŠ©è©ã®å¾Œã«å¥èª­ç‚¹', async () => {
    await cmp('ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨ã€è¡¨ç¤ºã€‚', 'ã“ã‚“ã«ã¡ã¯')
  })
  it('ä»£å…¥æ–‡', async () => {
    await cmp('3000ã‚’å€¤æ®µã«ä»£å…¥ã€‚å€¤æ®µã‚’è¡¨ç¤º', '3000')
    await cmp('å€¤æ®µã«3000ã‚’ä»£å…¥ã€‚å€¤æ®µã‚’è¡¨ç¤º', '3000')
    await cmp('ã€…=3000ã€‚ã€…ã‚’è¡¨ç¤º', '3000')
    await cmp('ã€…ã«3000ã‚’ä»£å…¥ã€‚ã€…ã‚’è¡¨ç¤º', '3000')
  })
  it('é€£æ–‡å¾Œã®ä»£å…¥æ–‡', async () => {
    await cmp('ã€Œaabbccã€ã®ã€Œaaã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦Fã«ä»£å…¥ã€‚Fã‚’è¡¨ç¤º', 'bbcc')
    await cmp('ã€Œaabbccã€ã®ã€Œaaã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦ã€Œbbã€ã‚’ã€Œã€ã«ç½®æ›ã—ã¦Fã«ä»£å…¥ã€‚Fã‚’è¡¨ç¤º', 'cc')
  })
  it('ã€œã‚’ã€œã«å®šã‚ã‚‹', async () => {
    await cmp('Aã‚’0.8ã«å®šã‚ã¦Aã‚’è¡¨ç¤º', '0.8')
  })
  it('æ–‡å­—åˆ— - &ã¨æ”¹è¡Œ', async () => {
    await cmp('ã€Œaaaã€& _\nã€Œbbbã€ã‚’è¡¨ç¤ºã€‚', 'aaabbb')
    await cmp('A= 1 + 1 + 1 + 1 + 1 + _\n1 + 1\nAã‚’è¡¨ç¤º', '7')
    await cmp('A= 1 + 1 + 1 + 1 + 1 + _\r\n1 + 1 + 1\r\nAã‚’è¡¨ç¤º', '8')
    await cmp('A= 1 + 1 + 1 + 1 + 1 + _  \r\n1 + 3  \r\nAã‚’è¡¨ç¤º', '9')
    await cmp('A = 1 + _\n' +
      '    5 + _\n' +
      '    10\n' +
      'Aã‚’è¡¨ç¤ºã€‚', '16')
  })
  it('åå‰ã«æ•°å­—ã‚’æŒã¤å¤‰æ•°ã‚’ä½¿ã†', async () => {
    await cmp('A1=30;B1=20;ã€Œ{A1}{B1}ã€ã‚’è¡¨ç¤ºã€‚', '3020')
  })
  it('åå‰ã«çµµæ–‡å­—ã‚’æŒã¤å¤‰æ•°ã‚’ä½¿ã†', async () => {
    await cmp('\u1F60=30;\u1F60ã‚’è¡¨ç¤ºã€‚', '30')
    await cmp('ğŸ˜„=30;ğŸ˜„ã‚’è¡¨ç¤ºã€‚', '30')
  })
  it('ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œãªã„å•é¡Œ (#112)', async () => {
    await cmp('A=50 # hogehoge\nAã‚’è¡¨ç¤º', '50')
    await cmp('A=50 ï¼ƒ hogehoge\nAã‚’è¡¨ç¤º', '50')
    await cmp('A=50 â€» hogehoge\nAã‚’è¡¨ç¤º', '50')
    await cmp('A=50 // hogehoge\nAã‚’è¡¨ç¤º', '50')
    await cmp('A=50 ï¼ï¼ hogehoge\nAã‚’è¡¨ç¤º', '50')
    await cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° # hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    await cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° ï¼ƒ hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    await cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° â€» hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    await cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° // hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
    await cmp('A=50\nã‚‚ã—A=50ãªã‚‰ã° ï¼ï¼ hogehoge\nAã‚’è¡¨ç¤º\nã“ã“ã¾ã§\n', '50')
  })
  it('ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã«æ–‡å­—åˆ—è¨˜å·ãŒã‚ã‚Šé–‰ã˜ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹(#725)', async () => {
    await cmp('A=50 # "hogehoge\nAã‚’è¡¨ç¤º', '50')
  })
  it('ç¯„å›²ã‚³ãƒ¡ãƒ³ãƒˆã«æ–‡å­—åˆ—è¨˜å·ãŒã‚ã‚Šé–‰ã˜ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹(#731)', async () => {
    await cmp('A=50 /* " */Aã‚’è¡¨ç¤º', '50')
    await cmp('A=50 /* \' */Aã‚’è¡¨ç¤º', '50')
  })
  // #1229
  it('usedFuncs', async () => {
    cmpNakoFuncs('3ã‚’è¡¨ç¤º', new Set(['è¡¨ç¤º']))
    cmpNakoFuncs('â—({é–¢æ•°}fã§aã‚’)æ¼”ç®—å‡¦ç†ã¨ã¯;ãã‚Œã¯ã€f(a);ã“ã“ã¾ã§;â—(aã‚’)äºŒå€å‡¦ç†ã¨ã¯;ãã‚Œã¯a*2;ã“ã“ã¾ã§;äºŒå€å‡¦ç†ã§2ã‚’æ¼”ç®—å‡¦ç†ã—ã¦è¡¨ç¤º', new Set(['è¡¨ç¤º']))
  })
  it('è«–æ–‡ãªã©ã§ä½¿ã‚ã‚Œã‚‹å¥èª­ç‚¹ã€Œï¼Œã€ã‚’ã€Œã€ã€(#735)', async () => {
    await cmp('A1=30;B1=20;(A1+B1)ã‚’ï¼Œè¡¨ç¤º', '50')
    await cmp('A=ï¼“ï¼ï¼‘ï¼”;Aã‚’ï¼Œè¡¨ç¤º', '3.14')
  })
  it('æ¡ä»¶åˆ†å²ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡', async () => {
    await cmp(
      'ï¼ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
      '3ã§æ¡ä»¶åˆ†å²\n' +
      '    2ãªã‚‰ã°\n' +
      '        2ã‚’è¡¨ç¤º\n' +
      '    3ãªã‚‰ã°\n' +
      '        3ã‚’è¡¨ç¤º\n' +
      '    é•ãˆã°\n' +
      '        4ã‚’è¡¨ç¤º\n', '3')
  })
  it('ğŸ’¡ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡ #1184', async () => {
    await cmp(
      'ğŸ’¡ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ§‹æ–‡\n' +
      '3ã§æ¡ä»¶åˆ†å²\n' +
      '    2ãªã‚‰ã°\n' +
      '        2ã‚’è¡¨ç¤º\n' +
      '    3ãªã‚‰ã°\n' +
      '        3ã‚’è¡¨ç¤º\n' +
      '    é•ãˆã°\n' +
      '        5ã‚’è¡¨ç¤º\n',
      '3'
    )
  })
  it('ç‹¬ç«‹ã—ãŸåŠ©è©ã€ãªã‚‰ã°ã€ã®ä½ç½®ã®å–å¾—', async () => {
    const nako = new NakoCompiler()
    const out = nako.lex('ã‚‚ã—å­˜åœ¨ã™ã‚‹ãªã‚‰ã°\nã“ã“ã¾ã§', '')
    const sonzai = out.tokens.find((t) => t.value === 'å­˜åœ¨')
    const naraba = out.tokens.find((t) => t.type === 'ãªã‚‰ã°')

    // ã€Œå­˜åœ¨ã™ã‚‹ã€
    expect(sonzai).to.have.property('startOffset').and.to.equal(2)
    expect(sonzai).to.have.property('endOffset').and.to.equal(6)

    // ãªã‚‰ã°
    expect(naraba).to.have.property('startOffset').and.to.equal(6)
    expect(naraba).to.have.property('endOffset').and.to.equal(9)
  })
  it('preCodeã‚’è€ƒæ…®ã—ãŸã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—', async () => {
    const nako = new NakoCompiler()
    const preCode = '1ã‚’è¡¨ç¤º\n2ã‚’è¡¨ç¤º\n3ã‚’'
    const tokens = nako.lex(preCode + 'è¡¨ç¤º', 'main.nako3', preCode).tokens

    // '3' ã¯-2ã‹ã‚‰0æ–‡å­—ç›®
    const three = tokens.findIndex((t) => t.value === 3)
    assert.strictEqual(tokens[three].startOffset, -2)
    assert.strictEqual(tokens[three].endOffset, 0)
    assert.strictEqual(tokens[three].line, 0)
    assert.strictEqual(tokens[three].column, -2)

    // 'è¡¨ç¤º' ã¯0~1æ–‡å­—ç›®
    assert.strictEqual(tokens[three + 1].startOffset, 0)
    assert.strictEqual(tokens[three + 1].endOffset, 2)
    assert.strictEqual(tokens[three + 1].line, 0)
    assert.strictEqual(tokens[three + 1].column, 0)
  })
  it('å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ - 1è¡Œã®ã¿', async () => {
    const nako = new NakoCompiler()
    nako.reset()
    await cmp(`
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã—ã¦1ã‚’è¡¨ç¤º
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã—ã¦2ã‚’è¡¨ç¤º
`, '1\n2')
  })
  it('å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ - ãƒ–ãƒ­ãƒƒã‚¯å†…ã«é©ç”¨', async () => {
    // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããªã‘ã‚Œã°ã€ã€Œå®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã€ãŒç„¡ã„å ´åˆã¨åŒã˜å‹•ä½œã‚’ã™ã‚‹ã€‚
    await cmp(`\
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ
    â—Fã¨ã¯
        2ã‚’è¡¨ç¤º
        3ã‚’è¡¨ç¤º
    ã“ã“ã¾ã§
    1ã‚’è¡¨ç¤º
    F
ã“ã“ã¾ã§
4ã‚’è¡¨ç¤º
`, '1\n2\n3\n4')
  })
  it('å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ - é–¢æ•°å®£è¨€ã®ä¸Šæ–¹ä¸‹æ–¹å‚ç…§', async () => {
    // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããªã‘ã‚Œã°ã€ã€Œå®Ÿè¡Œé€Ÿåº¦å„ªå…ˆã€ãŒç„¡ã„å ´åˆã¨åŒã˜å‹•ä½œã‚’ã™ã‚‹ã€‚
    await cmp(`\
ã€Œå…¨ã¦ã€ã§å®Ÿè¡Œé€Ÿåº¦å„ªå…ˆ
    â—Gã¨ã¯
        2ã‚’è¡¨ç¤º
        3ã‚’è¡¨ç¤º
    ã“ã“ã¾ã§
    â—Fã¨ã¯
        Eã™ã‚‹
    ã“ã“ã¾ã§
    â—Eã¨ã¯
        Gã™ã‚‹
    ã“ã“ã¾ã§
    1ã‚’è¡¨ç¤º
    F
ã“ã“ã¾ã§
4ã‚’è¡¨ç¤º
`, '1\n2\n3\n4')
  })
  it('ç©ºç™½ã§åŒºåˆ‡ã£ã¦æ–‡ã‚’ã¤ãªã’ãŸå ´åˆ', async () => {
    await cmp('1ã¨2ã‚’è¶³ã™ 1ã¨2ã‚’è¶³ã™', '')
  })
  it('return_none: true ã®addFuncã§å®šç¾©ã—ãŸé–¢æ•°ãŒã€Œãã‚Œã€ã«å€¤ã‚’ä»£å…¥ã—ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹', async () => {
    const nako = new NakoCompiler()
    nako.addFunc('hoge', [], () => { return 0 }, true)
    const g = await nako.run('1ã¨2ã‚’è¶³ã™\nhoge\nãã‚Œã‚’è¡¨ç¤º')
    assert.strictEqual(g.log, '3')
  })
  it('åˆ¶å¾¡æ§‹æ–‡ã§ä¸€èªé–¢æ•°ã‚’ä½¿ã†', async () => {
    await cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nã‚‚ã—ä¸€ãªã‚‰ã°\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§', '1') // if
    await cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€å›\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§', '1') // times
    await cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€ã®é–“\n1ã‚’è¡¨ç¤º\næŠœã‘ã‚‹\nã“ã“ã¾ã§', '1') // while
    await cmp('â—ä¸€ã¨ã¯\n[1]ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€ã‚’åå¾©\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§', '1') // foreach
    await cmp('â—ä¸€ã¨ã¯\n1ã‚’æˆ»ã™\nã“ã“ã¾ã§\nä¸€ã§æ¡ä»¶åˆ†å²\n1ãªã‚‰ã°\n1ã‚’è¡¨ç¤º\nã“ã“ã¾ã§\nã“ã“ã¾ã§', '1') // switch
  })
  it('ãã†', async () => {
    // ã€Œãã†ã€ã¯ã€Œãã‚Œã€ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
    await cmp('ãã‚Œï¼1;ãã†ã‚’è¡¨ç¤º', '1')
    await cmp('1ã«3ã‚’è¶³ã™;ãã†ã‚’è¡¨ç¤º', '4')
  })
  it('ã€Œã€œæ™‚é–“ã€ã®ã€Œé–“ã€ã‚’åˆ¶å¾¡æ§‹æ–‡ã¨ã—ã¦èªè­˜ã•ã›ãªã„ #831', async () => {
    await cmp('æ™‚é–“=1\nï¼ˆæ™‚é–“ï¼‰ã‚’è¡¨ç¤º', '1')
  })
  it('ã€Œã‚‚ã—FãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã°ã€ãŒFã¨ã€Œå­˜åœ¨ã™ã‚‹ã€ã®æ¯”è¼ƒã«ãªã‚‹å•é¡Œã®ä¿®æ­£ #830', async () => {
    await cmp(
      'â—ï¼ˆAãŒï¼‰hogeã¨ã¯\n' +
      '    1ã‚’æˆ»ã™\n' +
      'ã“ã“ã¾ã§\n' +
      'ã‚‚ã—ã€FãŒhogeãªã‚‰ã°\n' +
      '    1ã‚’è¡¨ç¤º\n' +
      'ã“ã“ã¾ã§',
      '1')
  })
  it('ç„¡åé–¢æ•°ãŒè­¦å‘Šã‚’å‡ºã™å•é¡Œã®ä¿®æ­£ #841', async () => {
    let log = ''
    const nako = new NakoCompiler()
    nako.getLogger().addListener('warn', ({ noColor }) => { log += noColor })
    nako.parse(
      'f = é–¢æ•°(x) ãã‚Œã¯ã€xã€‚ã“ã“ã¾ã§ã€‚\n' +
      'g = é–¢æ•°(x) ãã‚Œã¯ã€xã€‚ã“ã“ã¾ã§ã€‚\n'
      , 'main.nako3')
    assert.strictEqual(log, '')
  })
  /*
  it('resetã•ã‚ŒãŸå¾Œã«é–¢æ•°åã‚’å–å¾—ã§ããªã„å•é¡Œã®ä¿®æ­£ #849', (done) => {
    const nako = new NakoCompiler()
    nako.getLogger().addListener('stdout', (data) => {
      const { noColor } = data
      assert(noColor.includes('function')) // JavaScriptã®ã‚³ãƒ¼ãƒ‰ function() { var ... } ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
      done()
    })
    nako.run(`
â—Aã¨ã¯
ã“ã“ã¾ã§
0.0001ç§’å¾Œã«ã¯
    ã€ŒAã€ã®JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—ã—ã¦è¡¨ç¤º
ã“ã“ã¾ã§ã€‚
`, '')
    nako.reset()
    console.log(nako.compile(`\
â—ãƒ†ã‚¹ãƒˆ:è¶³ã™ã¨ã¯
    1ã¨2ã‚’è¶³ã™
    ãã‚Œã¨3ãŒASSERTç­‰ã—ã„
ã“ã“ã¾ã§

â—ãƒ†ã‚¹ãƒˆ:å¼•ãã¨ã¯
    1ã¨2ã‚’è¶³ã™
    ãã‚Œã¨3ãŒASSERTç­‰ã—ã„
ã“ã“ã¾ã§
`, 'main.nako3', true))
  })
  */
  //
  it('ã€ŒAã¯Bã§ã‚ã‚‹ã€æ§‹æ–‡ #939', async () => {
    await cmp('Aã¯9ã§ã‚ã‚‹ã€‚Aã‚’è¡¨ç¤º', '9')
    await cmp('Bã¯ã€Œã‚ã€ã§ã‚ã‚‹ã€‚Bã‚’è¡¨ç¤º', 'ã‚')
    await cmp('Cã¯[1,2,3]ã§ã‚ã‚‹;C[2]ã‚’è¡¨ç¤º', '3')
  })
  it('ã€ŒAã¯Bã§ã™ã€æ§‹æ–‡ #974', async () => {
    await cmp('Aã¯9ã§ã™ã€‚Aã‚’è¡¨ç¤º', '9')
    await cmp('Bã¯ã€Œã‚ã€ã§ã—ãŸã€‚Bã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚', 'ã‚')
    await cmp('Cã¯[1,2,3]ã§ã‚ã‚‹;C[2]ã‚’è¡¨ç¤º', '3')
  })
  it('è¤‡æ•°å¤‰æ•°ä»£å…¥æ§‹æ–‡ #563', async () => {
    await cmp('A,B=[1,2];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º', '1\n2')
    await cmp('A,B,C=[1,2,3];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º;Cã‚’è¡¨ç¤º', '1\n2\n3')
    await cmp('A,B=[1];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º;', '1\nundefined')
    await cmp('A,B,C,D=[1,2,3,4];Dã‚’è¡¨ç¤º;', '4')
  })
  it('è¤‡æ•°å®šæ•°ä»£å…¥æ§‹æ–‡ #563', async () => {
    await cmp('å®šæ•°[A,B]=[1,2];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º', '1\n2')
    await cmp('å®šæ•°[A,B,C]=[1,2,3];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º;Cã‚’è¡¨ç¤º', '1\n2\n3')
    await cmp('å®šæ•°[A,B]=[1];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º;', '1\nundefined')
    await cmp('å®šæ•°[A,B,C,D]=[1,2,3,4];Dã‚’è¡¨ç¤º;', '4')
  })
  it('è¤‡æ•°å®šæ•°ä»£å…¥æ§‹æ–‡ãã®2 #563', async () => {
    await cmp('å¤‰æ•°[A,B]=[1,2];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º', '1\n2')
    await cmp('å¤‰æ•°[A,B,C]=[1,2,3];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º;Cã‚’è¡¨ç¤º', '1\n2\n3')
    await cmp('å¤‰æ•°[A,B]=[1];Aã‚’è¡¨ç¤º;Bã‚’è¡¨ç¤º;', '1\nundefined')
    await cmp('å¤‰æ•°[A,B,C,D]=[1,2,3,4];Dã‚’è¡¨ç¤º;', '4')
  })
  it('è¤‡æ•°ä»£å…¥æ–‡ã®å•é¡Œ #1027', async () => {
    await cmp('å¡Š=[[0,0],[1,1]];å¡Šã‚’åå¾©\nx,y=å¯¾è±¡;ğŸ’§;å¡Šã‚’JSONã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤ºã€‚', '[[0,0],[1,1]]')
    await cmp('x=1;y=2;x,y=[y,x];xã‚’è¡¨ç¤º', '2')
  })
  it('ã‚‚ã—æ–‡ã§ã€Œãªã‚‰ã°ã€ã®å‰ã®ç©ºè¡Œã§ã‚¨ãƒ©ãƒ¼ #1079', async () => {
    await cmp('A=5;ã‚‚ã—ã€A > 3ã€€ãªã‚‰ã°ã€ŒOKã€ã¨è¡¨ç¤º;', 'OK')
  })
  it('ã€å¢—ã‚„ã™ã€ã€æ¸›ã‚‰ã™ã€æ–‡ã®è¿½åŠ  #1145', async () => {
    // å¢—ã‚„ã™
    await cmp('A=0;Aã‚’1å¢—ã‚„ã™ã€‚Aã¨è¡¨ç¤º;', '1')
    await cmp('A=0;Aã‚’123ã ã‘å¢—ã‚„ã™ã€‚Aã¨è¡¨ç¤º;', '123')
    // æ¸›ã‚‰ã™
    await cmp('A=10;Aã‚’1æ¸›ã‚‰ã™ã€‚Aã¨è¡¨ç¤º;', '9')
    await cmp('A=10;Aã‚’5ã ã‘æ¸›ã‚‰ã™ã€‚Aã¨è¡¨ç¤º;', '5')
    // åˆæœŸåŒ–ã—ãªã„ã§ä½¿ã†ã¨0ã«ãªã‚‹
    await cmp('Aã‚’3å¢—ã‚„ã™;Aã¨è¡¨ç¤º;', '3')
    await cmp('Aã‚’3æ¸›ã‚‰ã™;Aã¨è¡¨ç¤º;', '-3')
    // é…åˆ—è¦ç´ ã‚’å¢—ã‚„ã™
    await cmp('A = [0,1,2];A[1]ã‚’3å¢—ã‚„ã™;A[1]ã¨è¡¨ç¤º;', '4')
  })
  it('ã€å¢—ã‚„ã™ã€ã€æ¸›ã‚‰ã™ã€æ–‡ã®è¿½åŠ  #1386 (core #86)', async () => {
    // å¢—ã‚„ã™
    await cmp('A=[5,5,5];A[0]ã‚’1å¢—ã‚„ã™ã€‚A[0]ã¨è¡¨ç¤º;', '6')
    await cmp('A={"R":15};A["R"]ã‚’1å¢—ã‚„ã™ã€‚A["R"]ã¨è¡¨ç¤º;', '16')
    // æ¸›ã‚‰ã™
    await cmp('A=[5,5,5];A[0]ã‚’1æ¸›ã‚‰ã™ã€‚A[0]ã¨è¡¨ç¤º;', '4')
    await cmp('A={"R":15};A["R"]ã‚’1æ¸›ã‚‰ã™ã€‚A["R"]ã¨è¡¨ç¤º;', '14')
  })
  it('æ–‡å­—åˆ—è¨˜å·ã¨å…¨è§’ã‚³ãƒ¡ãƒ³ãƒˆé–‰ã˜è¨˜å·ã®çµ„ã¿åˆã‚ã›ãŒã‚ã‚‹æ™‚ã†ã¾ãå‹•ã„ã¦ã„ãªã„(core #45)', async () => {
    await cmp(
      'ã‚‚ã—1ãªã‚‰ã°\n' +
      'ã€€ã€€1ã‚’è¡¨ç¤º ï¼ï¼Š ã€Œ ï¼Šï¼\n' +
      'ã€€ã€€2ã‚’è¡¨ç¤º\n' +
      'ã“ã“ã¾ã§ã€‚\n' +
      '', '1\n2')
  })
  it('ã€Œã‚‚ã®ã€æ§‹æ–‡(#1614)', async () => {
    await cmp('1ã«2ã‚’è¶³ã—ãŸã‚‚ã®ã‚’è¡¨ç¤º', '3')
    await cmp('1ã«2ã‚’è¶³ã—ãŸã‚‚ã®ã«3ã‚’è¶³ã—ã¦è¡¨ç¤º', '6')
  })
  it('å¤‰æ•°ã‚’Objectã‹ã‚‰Mapã«å¤‰æ›´ã™ã‚‹(core#152)', async () => {
    await cmp('constructor=10;constructorã‚’è¡¨ç¤º', '10')
    await cmp('super=10;superã‚’è¡¨ç¤º', '10')
  })
  it('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰‹è»½ã«è¨­å®šã™ã‚‹-é€šå¸¸(#1793)', async () => {
    await cmp('A={"å¹…":30};A$å¹…=50;A$å¹…ã‚’è¡¨ç¤º', '50')
    await cmp('A={"é«˜":30};A$é«˜ã•=50;A$é«˜ã•ã‚’è¡¨ç¤º', '50') // é€ã‚Šä»®åã®çœç•¥
  })
  it('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰‹è»½ã«è¨­å®šã™ã‚‹-ãƒ‰ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹(#1807)', async () => {
    await cmp('A={"é«˜":30};A.é«˜=50;A.é«˜ã‚’è¡¨ç¤º', '50') // 
    await cmp('A={"A":30,"B":50};A.A=500;A.Aã‚’è¡¨ç¤º', '500') // 
  })
  it('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰‹è»½ã«è¨­å®šã™ã‚‹-ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£é–¢æ•°(#1793)', async () => {
    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’å–å¾—ã—ã¦10å€ã«ã—ã¦è¿”ã™
    await cmp(
      'ã€ (function(prop, sys){ return this[prop] * 10 })ã€ã‚’JSå®Ÿè¡Œã—ã¦F_GETã«ä»£å…¥ã€‚\n' +
      'ã€ (function(prop, val, sys){ this[prop] = val })ã€ã‚’JSå®Ÿè¡Œã—ã¦F_SETã«ä»£å…¥ã€‚\n' +
      'A={"å¹…": 3, "__setProp": F_SET, "__getProp": F_GET};\n' +
      'A$å¹…=5; A$å¹…ã‚’è¡¨ç¤º', '50')
    // å€¤ã‚’10å€ã«ã—ã¦æ ¼ç´
    await cmp(
      'ã€ (function(prop, sys){ return this[prop] })ã€ã‚’JSå®Ÿè¡Œã—ã¦F_GETã«ä»£å…¥ã€‚\n' +
      'ã€ (function(prop, val, sys){ this[prop] = val*10 })ã€ã‚’JSå®Ÿè¡Œã—ã¦F_SETã«ä»£å…¥ã€‚\n' +
      'A={"å¹…": 3, "__setProp": F_SET, "__getProp": F_GET};\n' +
      'A$å¹…=5; A$å¹…ã‚’è¡¨ç¤º', '50')
  })
  it('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰‹è»½ã«è¨­å®šã™ã‚‹-æ–‡å­—åˆ— (#1793)', async () => {
    await cmp('A={"å¹…":30};A$"å¹…"=50;A$"å¹…"ã‚’è¡¨ç¤º', '50')
    await cmp('A={"é«˜":30};A$"é«˜"=50;A$"é«˜"ã‚’è¡¨ç¤º', '50') // é€ã‚Šä»®åã®çœç•¥
  })
  it('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ§‹æ–‡$ã§ãƒã‚¹ãƒˆå¯èƒ½ã«ã™ã‚‹ #1805', async () => {
    await cmp('A={"ã‚¹ã‚¿ã‚¤ãƒ«":{"å¹…":300}};A$ã‚¹ã‚¿ã‚¤ãƒ«$å¹…=1;A$ã‚¹ã‚¿ã‚¤ãƒ«$å¹…ã‚’è¡¨ç¤º', '1')
    await cmp('A={"çŒ«":{"ä¸‰æ¯›çŒ«":1, "æ—¥æœ¬çŒ«":2}};A$çŒ«$æ—¥æœ¬çŒ«=123;A$çŒ«$æ—¥æœ¬çŒ«ã‚’è¡¨ç¤º', '123')
  })
  it('CSSã®å˜ä½ä»˜ãæ•°å€¤ã‚’æ–‡å­—åˆ—ã¨ã—ã¦èªè­˜ã•ã›ã‚‹ #1811', async () => {
    await cmp('(TYPEOF(30px))ã‚’è¡¨ç¤º', 'string')
    await cmp('A=30em;Aã‚’è¡¨ç¤º', '30em')
    await cmp('A=30px;Aã‚’JSONã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤º', '"30px"')
  })
  it('ç‰¹åˆ¥åå‰ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ†ã‚¹ãƒˆ #672 #1836', async () => {
    await cmp('ã€Šãƒªãƒ³ã‚´ã®å€¤æ®µã€‹=500;ã€Šãƒªãƒ³ã‚´ã®å€¤æ®µã€‹ã‚’è¡¨ç¤º', '500') // #672 å¤§ãªã‚Šè¨˜å·ã§ã¯ãªãã€äºŒé‡ã‚«ãƒƒã‚³ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„
    await cmp('${ãƒªãƒ³ã‚´ã®å€¤æ®µ}=500;${ãƒªãƒ³ã‚´ã®å€¤æ®µ}ã‚’è¡¨ç¤º', '500') // #1836
  })
})
