/* eslint-disable no-undef */
import assert from 'assert'
import { NakoCompiler } from '../src/nako3.mjs'
import { expect } from 'chai'

describe('basic', async () => {
  // nako.logger.addListener('trace', ({ browserConsole }) => { console.log(...browserConsole) })
  const cmp = async (/** @type {string} */code, /** @type {string} */res) => {
    const nako = new NakoCompiler()
    // nako.logger.debug('code=' + code)
    assert.strictEqual((await nako.runAsync(code, 'main.nako3')).log, res)
  }
  const cmpNakoFuncs = (/** @type {string} */code, /** @type {Set<string>} */res) => {
    const nako = new NakoCompiler()
    // nako.logger.debug('code=' + code)
    const ast = nako.parse(code, 'main.nako3')
    assert.deepStrictEqual(nako.getUsedFuncs(ast), res)
  }
  // --- test ---
  it('print simple', async () => {
    await cmp('3„ÇíË°®Á§∫', '3')
  })
  it('print', async () => {
    await cmp('3„ÇíË°®Á§∫', '3')
    await cmp('100„ÇíË°®Á§∫', '100')
    await cmp('0xFF„ÇíË°®Á§∫', '255')
  })
  it('string', async () => {
    await cmp('„Äåabc„Äç„ÇíË°®Á§∫', 'abc')
    await cmp('"abc"„ÇíË°®Á§∫', 'abc')
    await cmp('‚Äú„ÅÇ„ÅÑ„ÅÜ‚Äù„ÇíË°®Á§∫', '„ÅÇ„ÅÑ„ÅÜ')
  })
  it('rawstring', async () => {
    await cmp('„Äéabc„Äè„ÇíË°®Á§∫', 'abc')
    await cmp('\'abc\'„ÇíË°®Á§∫', 'abc')
    await cmp('„Äéabc{30}abc„Äè„ÇíË°®Á§∫', 'abc{30}abc')
  })
  it('string_ex1', async () => {
    await cmp('a=30;„Äåabc{a}abc„Äç„ÇíË°®Á§∫', 'abc30abc')
    await cmp('a=30;„ÄåabcÔΩõaÔΩùabc„Äç„ÇíË°®Á§∫', 'abc30abc')
  })
  it('string_ex2', async () => {
    await cmp('a=30;„Äåabc{a+1}abc„Äç„ÇíË°®Á§∫', 'abc31abc')
    await cmp('a=30;„ÄåabcÔΩõa+1ÔΩùabc„Äç„ÇíË°®Á§∫', 'abc31abc')
  })
  it('string_ex3', async () => {
    await cmp('a=30;„Äåabc{a„Å´2„ÇíÊéõ„Åë„Çã}abc„Äç„ÇíË°®Á§∫', 'abc60abc')
    await cmp('s=„Äå  @   „Äç;„Äåabc{s„Çí„Éà„É™„É†}abc„Äç„ÇíË°®Á§∫', 'abc@abc')
  })
  it('raw string - üåø .. üåø', async () => {
    await cmp('a=üåøabcüåø;a„ÇíË°®Á§∫', 'abc')
  })
  it('EX string - üå¥ .. üå¥', async () => {
    await cmp('v=30;a=üå¥abc{v}abcüå¥;a„ÇíË°®Á§∫', 'abc30abc')
  })
  it('string - LF', async () => {
    await cmp('a=30;„Äåabc\nabc„Äç„ÇíË°®Á§∫', 'abc\nabc')
  })
  it('space „Äå„Éª„Äç', async () => {
    await cmp('„Éªa=30;„Éªb=50„Äå{a}-{b}„Äç„ÇíË°®Á§∫', '30-50')
  })
  it('string - üå¥ ... üå¥', async () => {
    await cmp('üå¥aaaüå¥„ÇíË°®Á§∫', 'aaa')
    await cmp('a=30;üå¥aaa{a}bbbüå¥„ÇíË°®Á§∫', 'aaa30bbb')
    await cmp('a=30;üåøaaa{a}bbbüåø„ÇíË°®Á§∫', 'aaa{a}bbb')
  })
  it('„Ç∑„Çπ„ÉÜ„É†ÂÆöÊï∞', async () => {
    await cmp('„Éä„Éá„Ç∑„Ç≥„Ç®„É≥„Ç∏„É≥„ÇíË°®Á§∫', 'nadesi.com/v3')
  })
  it('Âä©Ë©û„ÅÆÂæå„Å´Âè•Ë™≠ÁÇπ', async () => {
    await cmp('„Äå„Åì„Çì„Å´„Å°„ÅØ„Äç„Å®„ÄÅË°®Á§∫„ÄÇ', '„Åì„Çì„Å´„Å°„ÅØ')
  })
  it('‰ª£ÂÖ•Êñá', async () => {
    await cmp('3000„ÇíÂÄ§ÊÆµ„Å´‰ª£ÂÖ•„ÄÇÂÄ§ÊÆµ„ÇíË°®Á§∫', '3000')
    await cmp('ÂÄ§ÊÆµ„Å´3000„Çí‰ª£ÂÖ•„ÄÇÂÄ§ÊÆµ„ÇíË°®Á§∫', '3000')
    await cmp('„ÄÖ=3000„ÄÇ„ÄÖ„ÇíË°®Á§∫', '3000')
    await cmp('„ÄÖ„Å´3000„Çí‰ª£ÂÖ•„ÄÇ„ÄÖ„ÇíË°®Á§∫', '3000')
  })
  it('ÈÄ£ÊñáÂæå„ÅÆ‰ª£ÂÖ•Êñá', async () => {
    await cmp('„Äåaabbcc„Äç„ÅÆ„Äåaa„Äç„Çí„Äå„Äç„Å´ÁΩÆÊèõ„Åó„Å¶F„Å´‰ª£ÂÖ•„ÄÇF„ÇíË°®Á§∫', 'bbcc')
    await cmp('„Äåaabbcc„Äç„ÅÆ„Äåaa„Äç„Çí„Äå„Äç„Å´ÁΩÆÊèõ„Åó„Å¶„Äåbb„Äç„Çí„Äå„Äç„Å´ÁΩÆÊèõ„Åó„Å¶F„Å´‰ª£ÂÖ•„ÄÇF„ÇíË°®Á§∫', 'cc')
  })
  it('„Äú„Çí„Äú„Å´ÂÆö„ÇÅ„Çã', async () => {
    await cmp('A„Çí0.8„Å´ÂÆö„ÇÅ„Å¶A„ÇíË°®Á§∫', '0.8')
  })
  it('ÊñáÂ≠óÂàó - &„Å®ÊîπË°å', async () => {
    await cmp('„Äåaaa„Äç& _\n„Äåbbb„Äç„ÇíË°®Á§∫„ÄÇ', 'aaabbb')
    await cmp('A= 1 + 1 + 1 + 1 + 1 + _\n1 + 1\nA„ÇíË°®Á§∫', '7')
    await cmp('A= 1 + 1 + 1 + 1 + 1 + _\r\n1 + 1 + 1\r\nA„ÇíË°®Á§∫', '8')
    await cmp('A= 1 + 1 + 1 + 1 + 1 + _  \r\n1 + 3  \r\nA„ÇíË°®Á§∫', '9')
    await cmp('A = 1 + _\n' +
      '    5 + _\n' +
      '    10\n' +
      'A„ÇíË°®Á§∫„ÄÇ', '16')
  })
  it('ÂêçÂâç„Å´Êï∞Â≠ó„ÇíÊåÅ„Å§Â§âÊï∞„Çí‰Ωø„ÅÜ', async () => {
    await cmp('A1=30;B1=20;„Äå{A1}{B1}„Äç„ÇíË°®Á§∫„ÄÇ', '3020')
  })
  it('ÂêçÂâç„Å´ÁµµÊñáÂ≠ó„ÇíÊåÅ„Å§Â§âÊï∞„Çí‰Ωø„ÅÜ', async () => {
    await cmp('\u1F60=30;\u1F60„ÇíË°®Á§∫„ÄÇ', '30')
    await cmp('üòÑ=30;üòÑ„ÇíË°®Á§∫„ÄÇ', '30')
  })
  it('„É©„Ç§„É≥„Ç≥„É°„É≥„Éà„ÅåÊ≠£„Åó„ÅèÂá¶ÁêÜ„Åï„Çå„Å™„ÅÑÂïèÈ°å (#112)', async () => {
    await cmp('A=50 # hogehoge\nA„ÇíË°®Á§∫', '50')
    await cmp('A=50 ÔºÉ hogehoge\nA„ÇíË°®Á§∫', '50')
    await cmp('A=50 ‚Äª hogehoge\nA„ÇíË°®Á§∫', '50')
    await cmp('A=50 // hogehoge\nA„ÇíË°®Á§∫', '50')
    await cmp('A=50 ÔºèÔºè hogehoge\nA„ÇíË°®Á§∫', '50')
    await cmp('A=50\n„ÇÇ„ÅóA=50„Å™„Çâ„Å∞ # hogehoge\nA„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß\n', '50')
    await cmp('A=50\n„ÇÇ„ÅóA=50„Å™„Çâ„Å∞ ÔºÉ hogehoge\nA„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß\n', '50')
    await cmp('A=50\n„ÇÇ„ÅóA=50„Å™„Çâ„Å∞ ‚Äª hogehoge\nA„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß\n', '50')
    await cmp('A=50\n„ÇÇ„ÅóA=50„Å™„Çâ„Å∞ // hogehoge\nA„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß\n', '50')
    await cmp('A=50\n„ÇÇ„ÅóA=50„Å™„Çâ„Å∞ ÔºèÔºè hogehoge\nA„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß\n', '50')
  })
  it('„É©„Ç§„É≥„Ç≥„É°„É≥„Éà„Å´ÊñáÂ≠óÂàóË®òÂè∑„Åå„ÅÇ„ÇäÈñâ„Åò„Å¶„ÅÑ„Å™„ÅÑ„Å®„Ç®„É©„Éº„Å´„Å™„Çã(#725)', async () => {
    await cmp('A=50 # "hogehoge\nA„ÇíË°®Á§∫', '50')
  })
  it('ÁØÑÂõ≤„Ç≥„É°„É≥„Éà„Å´ÊñáÂ≠óÂàóË®òÂè∑„Åå„ÅÇ„ÇäÈñâ„Åò„Å¶„ÅÑ„Å™„ÅÑ„Å®„Ç®„É©„Éº„Å´„Å™„Çã(#731)', async () => {
    await cmp('A=50 /* " */A„ÇíË°®Á§∫', '50')
    await cmp('A=50 /* \' */A„ÇíË°®Á§∫', '50')
  })
  // #1229
  it('usedFuncs', async () => {
    cmpNakoFuncs('3„ÇíË°®Á§∫', new Set(['Ë°®Á§∫']))
    cmpNakoFuncs('‚óè({Èñ¢Êï∞}f„Åßa„Çí)ÊºîÁÆóÂá¶ÁêÜ„Å®„ÅØ;„Åù„Çå„ÅØ„ÄÅf(a);„Åì„Åì„Åæ„Åß;‚óè(a„Çí)‰∫åÂÄçÂá¶ÁêÜ„Å®„ÅØ;„Åù„Çå„ÅØa*2;„Åì„Åì„Åæ„Åß;‰∫åÂÄçÂá¶ÁêÜ„Åß2„ÇíÊºîÁÆóÂá¶ÁêÜ„Åó„Å¶Ë°®Á§∫', new Set(['Ë°®Á§∫']))
  })
  it('Ë´ñÊñá„Å™„Å©„Åß‰Ωø„Çè„Çå„ÇãÂè•Ë™≠ÁÇπ„ÄåÔºå„Äç„Çí„Äå„ÄÅ„Äç(#735)', async () => {
    await cmp('A1=30;B1=20;(A1+B1)„ÇíÔºåË°®Á§∫', '50')
    await cmp('A=ÔºìÔºéÔºëÔºî;A„ÇíÔºåË°®Á§∫', '3.14')
  })
  it('Êù°‰ª∂ÂàÜÂ≤ê„ÅÆ„Ç§„É≥„Éá„É≥„ÉàÊßãÊñá', async () => {
    await cmp(
      'ÔºÅ„Ç§„É≥„Éá„É≥„ÉàÊßãÊñá\n' +
      '3„ÅßÊù°‰ª∂ÂàÜÂ≤ê\n' +
      '    2„Å™„Çâ„Å∞\n' +
      '        2„ÇíË°®Á§∫\n' +
      '    3„Å™„Çâ„Å∞\n' +
      '        3„ÇíË°®Á§∫\n' +
      '    ÈÅï„Åà„Å∞\n' +
      '        4„ÇíË°®Á§∫\n', '3')
  })
  it('üí°„ÅÆ„Ç§„É≥„Éá„É≥„ÉàÊßãÊñá #1184', async () => {
    await cmp(
      'üí°„Ç§„É≥„Éá„É≥„ÉàÊßãÊñá\n' +
      '3„ÅßÊù°‰ª∂ÂàÜÂ≤ê\n' +
      '    2„Å™„Çâ„Å∞\n' +
      '        2„ÇíË°®Á§∫\n' +
      '    3„Å™„Çâ„Å∞\n' +
      '        3„ÇíË°®Á§∫\n' +
      '    ÈÅï„Åà„Å∞\n' +
      '        5„ÇíË°®Á§∫\n',
      '3'
    )
  })
  it('Áã¨Á´ã„Åó„ÅüÂä©Ë©û„Äé„Å™„Çâ„Å∞„Äè„ÅÆ‰ΩçÁΩÆ„ÅÆÂèñÂæó', async () => {
    const nako = new NakoCompiler()
    const out = nako.lex('„ÇÇ„ÅóÂ≠òÂú®„Åô„Çã„Å™„Çâ„Å∞\n„Åì„Åì„Åæ„Åß', '')
    const sonzai = out.tokens.find((t) => t.value === 'Â≠òÂú®')
    const naraba = out.tokens.find((t) => t.type === '„Å™„Çâ„Å∞')

    // „ÄåÂ≠òÂú®„Åô„Çã„Äç
    expect(sonzai).to.have.property('startOffset').and.to.equal(2)
    expect(sonzai).to.have.property('endOffset').and.to.equal(6)

    // „Å™„Çâ„Å∞
    expect(naraba).to.have.property('startOffset').and.to.equal(6)
    expect(naraba).to.have.property('endOffset').and.to.equal(9)
  })
  it('preCode„ÇíËÄÉÊÖÆ„Åó„Åü„ÇΩ„Éº„Çπ„Éû„ÉÉ„Éó', async () => {
    const nako = new NakoCompiler()
    const preCode = '1„ÇíË°®Á§∫\n2„ÇíË°®Á§∫\n3„Çí'
    const tokens = nako.lex(preCode + 'Ë°®Á§∫', 'main.nako3', preCode).tokens

    // '3' „ÅØ-2„Åã„Çâ0ÊñáÂ≠óÁõÆ
    const three = tokens.findIndex((t) => t.value === 3)
    assert.strictEqual(tokens[three].startOffset, -2)
    assert.strictEqual(tokens[three].endOffset, 0)
    assert.strictEqual(tokens[three].line, 0)
    assert.strictEqual(tokens[three].column, -2)

    // 'Ë°®Á§∫' „ÅØ0~1ÊñáÂ≠óÁõÆ
    assert.strictEqual(tokens[three + 1].startOffset, 0)
    assert.strictEqual(tokens[three + 1].endOffset, 2)
    assert.strictEqual(tokens[three + 1].line, 0)
    assert.strictEqual(tokens[three + 1].column, 0)
  })
  it('ÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà - 1Ë°å„ÅÆ„Åø', async () => {
    const nako = new NakoCompiler()
    nako.reset()
    await cmp(`
„ÄåÂÖ®„Å¶„Äç„ÅßÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà„Åó„Å¶1„ÇíË°®Á§∫
„ÄåÂÖ®„Å¶„Äç„ÅßÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà„Åó„Å¶2„ÇíË°®Á§∫
`, '1\n2')
  })
  it('ÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà - „Éñ„É≠„ÉÉ„ÇØÂÜÖ„Å´ÈÅ©Áî®', async () => {
    // „Ç®„É©„Éº„ÅåËµ∑„Åç„Å™„Åë„Çå„Å∞„ÄÅ„ÄåÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà„Äç„ÅåÁÑ°„ÅÑÂ†¥Âêà„Å®Âêå„ÅòÂãï‰Ωú„Çí„Åô„Çã„ÄÇ
    await cmp(`\
„ÄåÂÖ®„Å¶„Äç„ÅßÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà
    ‚óèF„Å®„ÅØ
        2„ÇíË°®Á§∫
        3„ÇíË°®Á§∫
    „Åì„Åì„Åæ„Åß
    1„ÇíË°®Á§∫
    F
„Åì„Åì„Åæ„Åß
4„ÇíË°®Á§∫
`, '1\n2\n3\n4')
  })
  it('ÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà - Èñ¢Êï∞ÂÆ£Ë®Ä„ÅÆ‰∏äÊñπ‰∏ãÊñπÂèÇÁÖß', async () => {
    // „Ç®„É©„Éº„ÅåËµ∑„Åç„Å™„Åë„Çå„Å∞„ÄÅ„ÄåÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà„Äç„ÅåÁÑ°„ÅÑÂ†¥Âêà„Å®Âêå„ÅòÂãï‰Ωú„Çí„Åô„Çã„ÄÇ
    await cmp(`\
„ÄåÂÖ®„Å¶„Äç„ÅßÂÆüË°åÈÄüÂ∫¶ÂÑ™ÂÖà
    ‚óèG„Å®„ÅØ
        2„ÇíË°®Á§∫
        3„ÇíË°®Á§∫
    „Åì„Åì„Åæ„Åß
    ‚óèF„Å®„ÅØ
        E„Åô„Çã
    „Åì„Åì„Åæ„Åß
    ‚óèE„Å®„ÅØ
        G„Åô„Çã
    „Åì„Åì„Åæ„Åß
    1„ÇíË°®Á§∫
    F
„Åì„Åì„Åæ„Åß
4„ÇíË°®Á§∫
`, '1\n2\n3\n4')
  })
  it('Á©∫ÁôΩ„ÅßÂå∫Âàá„Å£„Å¶Êñá„Çí„Å§„Å™„Åí„ÅüÂ†¥Âêà', async () => {
    await cmp('1„Å®2„ÇíË∂≥„Åô 1„Å®2„ÇíË∂≥„Åô', '')
  })
  it('return_none: true „ÅÆaddFunc„ÅßÂÆöÁæ©„Åó„ÅüÈñ¢Êï∞„Åå„Äå„Åù„Çå„Äç„Å´ÂÄ§„Çí‰ª£ÂÖ•„Åó„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã', async () => {
    const nako = new NakoCompiler()
    nako.addFunc('hoge', [], () => { return 0 }, true)
    const g = await nako.run('1„Å®2„ÇíË∂≥„Åô\nhoge\n„Åù„Çå„ÇíË°®Á§∫')
    assert.strictEqual(g.log, '3')
  })
  it('Âà∂Âæ°ÊßãÊñá„Åß‰∏ÄË™ûÈñ¢Êï∞„Çí‰Ωø„ÅÜ', async () => {
    await cmp('‚óè‰∏Ä„Å®„ÅØ\n1„ÇíÊàª„Åô\n„Åì„Åì„Åæ„Åß\n„ÇÇ„Åó‰∏Ä„Å™„Çâ„Å∞\n1„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß', '1') // if
    await cmp('‚óè‰∏Ä„Å®„ÅØ\n1„ÇíÊàª„Åô\n„Åì„Åì„Åæ„Åß\n‰∏ÄÂõû\n1„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß', '1') // times
    await cmp('‚óè‰∏Ä„Å®„ÅØ\n1„ÇíÊàª„Åô\n„Åì„Åì„Åæ„Åß\n‰∏Ä„ÅÆÈñì\n1„ÇíË°®Á§∫\nÊäú„Åë„Çã\n„Åì„Åì„Åæ„Åß', '1') // while
    await cmp('‚óè‰∏Ä„Å®„ÅØ\n[1]„ÇíÊàª„Åô\n„Åì„Åì„Åæ„Åß\n‰∏Ä„ÇíÂèçÂæ©\n1„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß', '1') // foreach
    await cmp('‚óè‰∏Ä„Å®„ÅØ\n1„ÇíÊàª„Åô\n„Åì„Åì„Åæ„Åß\n‰∏Ä„ÅßÊù°‰ª∂ÂàÜÂ≤ê\n1„Å™„Çâ„Å∞\n1„ÇíË°®Á§∫\n„Åì„Åì„Åæ„Åß\n„Åì„Åì„Åæ„Åß', '1') // switch
  })
  it('„Åù„ÅÜ', async () => {
    // „Äå„Åù„ÅÜ„Äç„ÅØ„Äå„Åù„Çå„Äç„ÅÆ„Ç®„Ç§„É™„Ç¢„Çπ
    await cmp('„Åù„ÇåÔºù1;„Åù„ÅÜ„ÇíË°®Á§∫', '1')
    await cmp('1„Å´3„ÇíË∂≥„Åô;„Åù„ÅÜ„ÇíË°®Á§∫', '4')
  })
  it('„Äå„ÄúÊôÇÈñì„Äç„ÅÆ„ÄåÈñì„Äç„ÇíÂà∂Âæ°ÊßãÊñá„Å®„Åó„Å¶Ë™çË≠ò„Åï„Åõ„Å™„ÅÑ #831', async () => {
    await cmp('ÊôÇÈñì=1\nÔºàÊôÇÈñìÔºâ„ÇíË°®Á§∫', '1')
  })
  it('„Äå„ÇÇ„ÅóF„ÅåÂ≠òÂú®„Åô„Çã„Å™„Çâ„Å∞„Äç„ÅåF„Å®„ÄåÂ≠òÂú®„Åô„Çã„Äç„ÅÆÊØîËºÉ„Å´„Å™„ÇãÂïèÈ°å„ÅÆ‰øÆÊ≠£ #830', async () => {
    await cmp(
      '‚óèÔºàA„ÅåÔºâhoge„Å®„ÅØ\n' +
      '    1„ÇíÊàª„Åô\n' +
      '„Åì„Åì„Åæ„Åß\n' +
      '„ÇÇ„Åó„ÄÅF„Ååhoge„Å™„Çâ„Å∞\n' +
      '    1„ÇíË°®Á§∫\n' +
      '„Åì„Åì„Åæ„Åß',
      '1')
  })
  it('ÁÑ°ÂêçÈñ¢Êï∞„ÅåË≠¶Âëä„ÇíÂá∫„ÅôÂïèÈ°å„ÅÆ‰øÆÊ≠£ #841', async () => {
    let log = ''
    const nako = new NakoCompiler()
    nako.getLogger().addListener('warn', ({ noColor }) => { log += noColor })
    nako.parse(
      'f = Èñ¢Êï∞(x) „Åù„Çå„ÅØ„ÄÅx„ÄÇ„Åì„Åì„Åæ„Åß„ÄÇ\n' +
      'g = Èñ¢Êï∞(x) „Åù„Çå„ÅØ„ÄÅx„ÄÇ„Åì„Åì„Åæ„Åß„ÄÇ\n'
      , 'main.nako3')
    assert.strictEqual(log, '')
  })
  /*
  it('reset„Åï„Çå„ÅüÂæå„Å´Èñ¢Êï∞Âêç„ÇíÂèñÂæó„Åß„Åç„Å™„ÅÑÂïèÈ°å„ÅÆ‰øÆÊ≠£ #849', (done) => {
    const nako = new NakoCompiler()
    nako.getLogger().addListener('stdout', (data) => {
      const { noColor } = data
      assert(noColor.includes('function')) // JavaScript„ÅÆ„Ç≥„Éº„Éâ function() { var ... } „ÅåË°®Á§∫„Åï„Çå„Çã„ÅØ„Åö
      done()
    })
    nako.run(`
‚óèA„Å®„ÅØ
„Åì„Åì„Åæ„Åß
0.0001ÁßíÂæå„Å´„ÅØ
    „ÄåA„Äç„ÅÆJS„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂèñÂæó„Åó„Å¶Ë°®Á§∫
„Åì„Åì„Åæ„Åß„ÄÇ
`, '')
    nako.reset()
    console.log(nako.compile(`\
‚óè„ÉÜ„Çπ„Éà:Ë∂≥„Åô„Å®„ÅØ
    1„Å®2„ÇíË∂≥„Åô
    „Åù„Çå„Å®3„ÅåASSERTÁ≠â„Åó„ÅÑ
„Åì„Åì„Åæ„Åß

‚óè„ÉÜ„Çπ„Éà:Âºï„Åè„Å®„ÅØ
    1„Å®2„ÇíË∂≥„Åô
    „Åù„Çå„Å®3„ÅåASSERTÁ≠â„Åó„ÅÑ
„Åì„Åì„Åæ„Åß
`, 'main.nako3', true))
  })
  */
  //
  it('„ÄåA„ÅØB„Åß„ÅÇ„Çã„ÄçÊßãÊñá #939', async () => {
    await cmp('A„ÅØ9„Åß„ÅÇ„Çã„ÄÇA„ÇíË°®Á§∫', '9')
    await cmp('B„ÅØ„Äå„ÅÇ„Äç„Åß„ÅÇ„Çã„ÄÇB„ÇíË°®Á§∫', '„ÅÇ')
    await cmp('C„ÅØ[1,2,3]„Åß„ÅÇ„Çã;C[2]„ÇíË°®Á§∫', '3')
  })
  it('„ÄåA„ÅØB„Åß„Åô„ÄçÊßãÊñá #974', async () => {
    await cmp('A„ÅØ9„Åß„Åô„ÄÇA„ÇíË°®Á§∫', '9')
    await cmp('B„ÅØ„Äå„ÅÇ„Äç„Åß„Åó„Åü„ÄÇB„ÇíË°®Á§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', '„ÅÇ')
    await cmp('C„ÅØ[1,2,3]„Åß„ÅÇ„Çã;C[2]„ÇíË°®Á§∫', '3')
  })
  it('Ë§áÊï∞Â§âÊï∞‰ª£ÂÖ•ÊßãÊñá #563', async () => {
    await cmp('A,B=[1,2];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫', '1\n2')
    await cmp('A,B,C=[1,2,3];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫;C„ÇíË°®Á§∫', '1\n2\n3')
    await cmp('A,B=[1];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫;', '1\nundefined')
    await cmp('A,B,C,D=[1,2,3,4];D„ÇíË°®Á§∫;', '4')
  })
  it('Ë§áÊï∞ÂÆöÊï∞‰ª£ÂÖ•ÊßãÊñá #563', async () => {
    await cmp('ÂÆöÊï∞[A,B]=[1,2];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫', '1\n2')
    await cmp('ÂÆöÊï∞[A,B,C]=[1,2,3];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫;C„ÇíË°®Á§∫', '1\n2\n3')
    await cmp('ÂÆöÊï∞[A,B]=[1];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫;', '1\nundefined')
    await cmp('ÂÆöÊï∞[A,B,C,D]=[1,2,3,4];D„ÇíË°®Á§∫;', '4')
  })
  it('Ë§áÊï∞ÂÆöÊï∞‰ª£ÂÖ•ÊßãÊñá„Åù„ÅÆ2 #563', async () => {
    await cmp('Â§âÊï∞[A,B]=[1,2];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫', '1\n2')
    await cmp('Â§âÊï∞[A,B,C]=[1,2,3];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫;C„ÇíË°®Á§∫', '1\n2\n3')
    await cmp('Â§âÊï∞[A,B]=[1];A„ÇíË°®Á§∫;B„ÇíË°®Á§∫;', '1\nundefined')
    await cmp('Â§âÊï∞[A,B,C,D]=[1,2,3,4];D„ÇíË°®Á§∫;', '4')
  })
  it('Ë§áÊï∞‰ª£ÂÖ•Êñá„ÅÆÂïèÈ°å #1027', async () => {
    await cmp('Â°ä=[[0,0],[1,1]];Â°ä„ÇíÂèçÂæ©\nx,y=ÂØæË±°;üíß;Â°ä„ÇíJSON„Ç®„É≥„Ç≥„Éº„Éâ„Åó„Å¶Ë°®Á§∫„ÄÇ', '[[0,0],[1,1]]')
    await cmp('x=1;y=2;x,y=[y,x];x„ÇíË°®Á§∫', '2')
  })
  it('„ÇÇ„ÅóÊñá„Åß„Äå„Å™„Çâ„Å∞„Äç„ÅÆÂâç„ÅÆÁ©∫Ë°å„Åß„Ç®„É©„Éº #1079', async () => {
    await cmp('A=5;„ÇÇ„Åó„ÄÅA > 3„ÄÄ„Å™„Çâ„Å∞„ÄåOK„Äç„Å®Ë°®Á§∫;', 'OK')
  })
  it('„ÄéÂ¢ó„ÇÑ„Åô„Äè„ÄéÊ∏õ„Çâ„Åô„ÄèÊñá„ÅÆËøΩÂä† #1145', async () => {
    // Â¢ó„ÇÑ„Åô
    await cmp('A=0;A„Çí1Â¢ó„ÇÑ„Åô„ÄÇA„Å®Ë°®Á§∫;', '1')
    await cmp('A=0;A„Çí123„Å†„ÅëÂ¢ó„ÇÑ„Åô„ÄÇA„Å®Ë°®Á§∫;', '123')
    // Ê∏õ„Çâ„Åô
    await cmp('A=10;A„Çí1Ê∏õ„Çâ„Åô„ÄÇA„Å®Ë°®Á§∫;', '9')
    await cmp('A=10;A„Çí5„Å†„ÅëÊ∏õ„Çâ„Åô„ÄÇA„Å®Ë°®Á§∫;', '5')
    // ÂàùÊúüÂåñ„Åó„Å™„ÅÑ„Åß‰Ωø„ÅÜ„Å®0„Å´„Å™„Çã
    await cmp('A„Çí3Â¢ó„ÇÑ„Åô;A„Å®Ë°®Á§∫;', '3')
    await cmp('A„Çí3Ê∏õ„Çâ„Åô;A„Å®Ë°®Á§∫;', '-3')
    // ÈÖçÂàóË¶ÅÁ¥†„ÇíÂ¢ó„ÇÑ„Åô
    await cmp('A = [0,1,2];A[1]„Çí3Â¢ó„ÇÑ„Åô;A[1]„Å®Ë°®Á§∫;', '4')
  })
  it('„ÄéÂ¢ó„ÇÑ„Åô„Äè„ÄéÊ∏õ„Çâ„Åô„ÄèÊñá„ÅÆËøΩÂä† #1386 (core #86)', async () => {
    // Â¢ó„ÇÑ„Åô
    await cmp('A=[5,5,5];A[0]„Çí1Â¢ó„ÇÑ„Åô„ÄÇA[0]„Å®Ë°®Á§∫;', '6')
    await cmp('A={"R":15};A["R"]„Çí1Â¢ó„ÇÑ„Åô„ÄÇA["R"]„Å®Ë°®Á§∫;', '16')
    // Ê∏õ„Çâ„Åô
    await cmp('A=[5,5,5];A[0]„Çí1Ê∏õ„Çâ„Åô„ÄÇA[0]„Å®Ë°®Á§∫;', '4')
    await cmp('A={"R":15};A["R"]„Çí1Ê∏õ„Çâ„Åô„ÄÇA["R"]„Å®Ë°®Á§∫;', '14')
  })
  it('ÊñáÂ≠óÂàóË®òÂè∑„Å®ÂÖ®Ëßí„Ç≥„É°„É≥„ÉàÈñâ„ÅòË®òÂè∑„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Åå„ÅÇ„ÇãÊôÇ„ÅÜ„Åæ„ÅèÂãï„ÅÑ„Å¶„ÅÑ„Å™„ÅÑ(core #45)', async () => {
    await cmp(
      '„ÇÇ„Åó1„Å™„Çâ„Å∞\n' +
      '„ÄÄ„ÄÄ1„ÇíË°®Á§∫ ÔºèÔºä „Äå ÔºäÔºè\n' +
      '„ÄÄ„ÄÄ2„ÇíË°®Á§∫\n' +
      '„Åì„Åì„Åæ„Åß„ÄÇ\n' +
      '', '1\n2')
  })
  it('„Äå„ÇÇ„ÅÆ„ÄçÊßãÊñá(#1614)', async () => {
    await cmp('1„Å´2„ÇíË∂≥„Åó„Åü„ÇÇ„ÅÆ„ÇíË°®Á§∫', '3')
    await cmp('1„Å´2„ÇíË∂≥„Åó„Åü„ÇÇ„ÅÆ„Å´3„ÇíË∂≥„Åó„Å¶Ë°®Á§∫', '6')
  })
  it('Â§âÊï∞„ÇíObject„Åã„ÇâMap„Å´Â§âÊõ¥„Åô„Çã(core#152)', async () => {
    await cmp('constructor=10;constructor„ÇíË°®Á§∫', '10')
    await cmp('super=10;super„ÇíË°®Á§∫', '10')
  })
  it('„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊâãËªΩ„Å´Ë®≠ÂÆö„Åô„Çã-ÈÄöÂ∏∏(#1793)', async () => {
    await cmp('A={"ÂπÖ":30};A$ÂπÖ=50;A$ÂπÖ„ÇíË°®Á§∫', '50')
    await cmp('A={"È´ò":30};A$È´ò„Åï=50;A$È´ò„Åï„ÇíË°®Á§∫', '50') // ÈÄÅ„Çä‰ªÆÂêç„ÅÆÁúÅÁï•
  })
  it('„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊâãËªΩ„Å´Ë®≠ÂÆö„Åô„Çã-„Éâ„ÉÉ„Éà„Ç¢„ÇØ„Çª„Çπ(#1807)', async () => {
    await cmp('A={"È´ò":30};A.È´ò=50;A.È´ò„ÇíË°®Á§∫', '50') // 
    await cmp('A={"A":30,"B":50};A.A=500;A.A„ÇíË°®Á§∫', '500') // 
  })
  it('„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊâãËªΩ„Å´Ë®≠ÂÆö„Åô„Çã-„Éó„É≠„Éë„ÉÜ„Ç£Èñ¢Êï∞(#1793)', async () => {
    // „Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂÄ§„ÇíÂèñÂæó„Åó„Å¶10ÂÄç„Å´„Åó„Å¶Ëøî„Åô
    await cmp(
      '„Äé (function(prop, sys){ return this[prop] * 10 })„Äè„ÇíJSÂÆüË°å„Åó„Å¶F_GET„Å´‰ª£ÂÖ•„ÄÇ\n' +
      '„Äé (function(prop, val, sys){ this[prop] = val })„Äè„ÇíJSÂÆüË°å„Åó„Å¶F_SET„Å´‰ª£ÂÖ•„ÄÇ\n' +
      'A={"ÂπÖ": 3, "__setProp": F_SET, "__getProp": F_GET};\n' +
      'A$ÂπÖ=5; A$ÂπÖ„ÇíË°®Á§∫', '50')
    // ÂÄ§„Çí10ÂÄç„Å´„Åó„Å¶Ê†ºÁ¥ç
    await cmp(
      '„Äé (function(prop, sys){ return this[prop] })„Äè„ÇíJSÂÆüË°å„Åó„Å¶F_GET„Å´‰ª£ÂÖ•„ÄÇ\n' +
      '„Äé (function(prop, val, sys){ this[prop] = val*10 })„Äè„ÇíJSÂÆüË°å„Åó„Å¶F_SET„Å´‰ª£ÂÖ•„ÄÇ\n' +
      'A={"ÂπÖ": 3, "__setProp": F_SET, "__getProp": F_GET};\n' +
      'A$ÂπÖ=5; A$ÂπÖ„ÇíË°®Á§∫', '50')
  })
  it('„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊâãËªΩ„Å´Ë®≠ÂÆö„Åô„Çã-ÊñáÂ≠óÂàó (#1793)', async () => {
    await cmp('A={"ÂπÖ":30};A$"ÂπÖ"=50;A$"ÂπÖ"„ÇíË°®Á§∫', '50')
    await cmp('A={"È´ò":30};A$"È´ò"=50;A$"È´ò"„ÇíË°®Á§∫', '50') // ÈÄÅ„Çä‰ªÆÂêç„ÅÆÁúÅÁï•
  })
  it('„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Éó„É≠„Éë„ÉÜ„Ç£ÊßãÊñá$„Åß„Éç„Çπ„ÉàÂèØËÉΩ„Å´„Åô„Çã #1805', async () => {
    await cmp('A={"„Çπ„Çø„Ç§„É´":{"ÂπÖ":300}};A$„Çπ„Çø„Ç§„É´$ÂπÖ=1;A$„Çπ„Çø„Ç§„É´$ÂπÖ„ÇíË°®Á§∫', '1')
    await cmp('A={"Áå´":{"‰∏âÊØõÁå´":1, "Êó•Êú¨Áå´":2}};A$Áå´$Êó•Êú¨Áå´=123;A$Áå´$Êó•Êú¨Áå´„ÇíË°®Á§∫', '123')
  })
  it('CSS„ÅÆÂçò‰Ωç‰ªò„ÅçÊï∞ÂÄ§„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶Ë™çË≠ò„Åï„Åõ„Çã #1811', async () => {
    await cmp('(TYPEOF(30px))„ÇíË°®Á§∫', 'string')
    await cmp('A=30em;A„ÇíË°®Á§∫', '30em')
    await cmp('A=30px;A„ÇíJSON„Ç®„É≥„Ç≥„Éº„Éâ„Åó„Å¶Ë°®Á§∫', '"30px"')
  })
})
